<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>RANKLOCK v9.4 | DEBT & CURRENCY</title>
    <meta name="author" content="Ojas Kadam">
    <meta name="description" content="RankLock v9.4. XP Economy, Time-Based Debt, and Event Management.">
    
    <!-- 
        RANKLOCK DISCIPLINE SYSTEM v9.4
        Architect: Ojas Kadam
        
        CHANGELOG v9.4:
        1. ECONOMY: XP is now Currency. Added "Black Market" to spend XP.
        2. INFLATION: Daily XP Cap (1500) implemented. 90% tax after cap.
        3. DEBT 2.0: Debt is Time-Based (Minutes). Active Debt = 50% XP Tax.
        4. EVENTS: Added Edit/Delete for events. Official links verified.
        5. UI: Added "Debt Clearance" mode in Session Wizard.
    -->
    <style>
        /* --- CSS ARCHITECTURE: RANKLOCK DESIGN LANGUAGE (RDL) --- */
        :root {
            --bg-deep: #050508;
            --bg-surface: #0f0f16;
            --bg-elevated: #1a1a24;
            
            /* High Contrast & Readability */
            --text-primary: #ffffff;      
            --text-secondary: #d1d5db;    
            --text-muted: #6b7280;        
            
            --accent-primary: #3b82f6;
            --accent-warn: #f59e0b;
            --accent-crit: #ef4444;
            --accent-succ: #10b981;
            --accent-void: #6366f1;
            --accent-gold: #ffd700;
            --accent-lock: #06b6d4; 
            --accent-debt: #7f1d1d;
            
            --border-ui: #374151;
            
            --font-main: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            --font-mono: 'JetBrains Mono', 'Fira Code', monospace;
            
            --radius-sm: 4px;
            --radius-md: 8px;
            --radius-lg: 12px;
            
            --mobile-nav-height: 65px;
        }

        /* --- Global Resets --- */
        * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
        body { background-color: var(--bg-deep); color: var(--text-primary); font-family: var(--font-main); overflow: hidden; height: 100vh; width: 100vw; }
        
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: var(--bg-deep); }
        ::-webkit-scrollbar-thumb { background: var(--border-ui); border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--text-muted); }

        h1, h2, h3 { font-weight: 700; letter-spacing: -0.02em; }
        .mono { font-family: var(--font-mono); }
        .tabular { font-variant-numeric: tabular-nums; }
        .hidden { display: none !important; }

        /* --- Layout --- */
        #app-container { display: flex; flex-direction: column; height: 100%; width: 100%; max-width: 1600px; margin: 0 auto; position: relative; }

        /* --- Header --- */
        nav { height: 60px; padding: 0 16px; display: flex; align-items: center; justify-content: space-between; border-bottom: 1px solid var(--border-ui); background: var(--bg-deep); z-index: 100; }
        .nav-left { display: flex; align-items: center; gap: 16px; }
        .nav-logo { font-size: 1.1rem; font-weight: 800; display: flex; align-items: center; gap: 12px; letter-spacing: 0.05em; }
        .nav-logo span { font-size: 0.6rem; background: var(--accent-lock); padding: 2px 6px; border-radius: var(--radius-sm); color: var(--bg-deep); font-weight: 900; }
        .nav-right { display: flex; gap: 12px; align-items: center; }
        
        .stat-item { text-align: right; display: flex; flex-direction: column; justify-content: center; margin-right: 8px; }
        .stat-label { font-size: 0.6rem; color: var(--text-muted); font-weight: 700; text-transform: uppercase; }
        .stat-value { font-size: 0.9rem; font-weight: 600; }
        
        .stat-value.streak-fire { color: var(--accent-warn); text-shadow: 0 0 10px rgba(245, 158, 11, 0.3); }
        .stat-value.integrity-ok { color: var(--accent-succ); }
        .stat-value.integrity-warn { color: var(--accent-warn); }
        .stat-value.integrity-crit { color: var(--accent-crit); animation: glitchText 0.5s infinite; }

        .icon-btn { background: none; border: none; color: var(--text-secondary); cursor: pointer; padding: 8px; border-radius: var(--radius-sm); transition: 0.2s; display: flex; align-items: center; justify-content: center;}
        .icon-btn:hover { background: var(--bg-elevated); color: var(--text-primary); }
        
        /* Sidebar Toggle Button (Desktop Only) */
        .sidebar-toggle { 
            border: 1px solid var(--border-ui); 
            width: 32px; height: 32px; 
            display: flex; align-items: center; justify-content: center; 
            border-radius: var(--radius-sm); cursor: pointer; 
            color: var(--text-muted); 
            background: transparent;
            transition: all 0.2s;
        }
        .sidebar-toggle:hover { 
            background: var(--bg-elevated); 
            color: var(--text-primary);
            border-color: var(--text-secondary);
        }

        /* --- Main Content --- */
        main { flex: 1; padding: 16px; display: grid; grid-template-columns: 320px 1fr; gap: 16px; overflow: hidden; transition: all 0.3s ease; }
        main.sidebar-collapsed { grid-template-columns: 0px 1fr; gap: 0; }
        main.sidebar-collapsed .sidebar { opacity: 0; pointer-events: none; }

        /* --- Sidebar --- */
        .sidebar { display: flex; flex-direction: column; gap: 16px; overflow-y: auto; padding-right: 4px; transition: opacity 0.2s; min-width: 320px; }

        .card { background: var(--bg-surface); border: 1px solid var(--border-ui); border-radius: var(--radius-md); padding: 16px; display: flex; flex-direction: column; position: relative; }
        .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; border-bottom: 1px solid var(--border-ui); padding-bottom: 8px; }
        .card-title { font-size: 0.75rem; font-weight: 800; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.05em; }

        .rank-box { text-align: center; padding: 10px 0; }
        .rank-value { font-size: 3rem; font-weight: 900; font-family: var(--font-mono); color: var(--accent-lock); line-height: 1; }
        .rank-label { font-size: 0.8rem; font-weight: 700; letter-spacing: 0.1em; margin-top: 4px; color: var(--text-primary); }
        .rank-progress { height: 4px; background: var(--bg-elevated); margin-top: 12px; border-radius: 2px; overflow: hidden; }
        .rank-bar { height: 100%; background: var(--accent-lock); width: 0%; transition: width 0.5s ease; }
        .rank-perk-badge { font-size: 0.65rem; background: rgba(6, 182, 212, 0.1); color: var(--accent-lock); padding: 4px 8px; border-radius: 10px; display: inline-block; margin-top: 8px; border: 1px solid rgba(6, 182, 212, 0.3); }

        .architect-tag { text-align: center; font-size: 0.65rem; color: var(--text-muted); padding: 10px; opacity: 0.8; }

        /* --- Central Stage --- */
        .stage { display: flex; flex-direction: column; height: 100%; position: relative; }
        .focus-container { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; background: var(--bg-surface); border: 1px solid var(--border-ui); border-radius: var(--radius-lg); position: relative; overflow: hidden; transition: border-color 0.5s; }

        #timer-display { font-size: 9rem; font-weight: 800; font-family: var(--font-mono); z-index: 2; line-height: 1; color: var(--text-primary); }
        .focus-bg-pulse { position: absolute; width: 600px; height: 600px; background: radial-gradient(circle, var(--accent-lock) 0%, transparent 70%); opacity: 0; border-radius: 50%; pointer-events: none; }

        /* Visual Overlays */
        #integrity-visual-overlay { position: absolute; inset:0; pointer-events:none; border: 0px solid var(--accent-crit); transition: 0.1s; z-index: 10; box-shadow: inset 0 0 0px var(--accent-crit); opacity: 0; }
        
        #countdown-overlay { position: absolute; inset:0; background: var(--bg-deep); z-index: 20; display: none; flex-direction: column; align-items: center; justify-content: center; }
        .countdown-val { font-size: 8rem; font-weight: 900; color: var(--text-primary); animation: pulse 1s infinite; }
        .countdown-label { font-size: 1rem; color: var(--accent-lock); letter-spacing: 0.2em; text-transform: uppercase; margin-top: 10px; }

        .session-context { text-align: center; z-index: 2; margin-top: 20px; }
        .context-subject { font-size: 1.2rem; font-weight: 700; color: var(--accent-lock); }
        .context-chapter { font-size: 0.9rem; color: var(--text-secondary); }
        .context-goal { font-size: 0.8rem; color: var(--text-muted); margin-top: 8px; font-style: italic; border-top: 1px solid var(--border-ui); padding-top: 8px; display: inline-block; }

        .session-integrity-badge { position: absolute; top: 20px; right: 20px; background: var(--bg-elevated); padding: 8px 16px; border-radius: var(--radius-lg); font-weight: 700; border: 1px solid var(--border-ui); display: none; }
        .session-integrity-badge.active { display: block; animation: fadeIn 0.5s; }

        .controls { display: flex; gap: 16px; margin-top: 40px; z-index: 2; }
        
        .btn { padding: 14px 32px; font-weight: 700; text-transform: uppercase; font-size: 0.85rem; border-radius: var(--radius-md); cursor: pointer; border: none; transition: all 0.2s; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .btn-primary { background: var(--accent-lock); color: var(--bg-deep); box-shadow: 0 4px 12px rgba(6, 182, 212, 0.3); }
        .btn-primary:hover { filter: brightness(1.1); transform: translateY(-1px); }
        .btn-primary:disabled { opacity: 0.5; cursor: not-allowed; transform: none; filter: none; }
        
        .btn-outline { background: transparent; border: 1px solid var(--border-ui); color: var(--text-secondary); }
        .btn-outline:hover { background: var(--bg-elevated); color: var(--text-primary); border-color: var(--text-muted); }
        .btn-crit { background: rgba(239, 68, 68, 0.1); color: var(--accent-crit); border: 1px solid var(--accent-crit); }
        .btn-crit:hover { background: var(--accent-crit); color: white; }
        .btn-block { width: 100%; }
        
        /* Custom Input */
        .custom-time-input { background: var(--bg-deep); border: 1px solid var(--border-ui); color: var(--text-primary); border-radius: var(--radius-md); text-align: center; font-family: var(--font-mono); font-weight: 700; width: 100%; height: 100%; min-height: 52px; font-size: 1rem; transition: border-color 0.2s; }
        .custom-time-input:focus { border-color: var(--accent-lock); outline: none; }

        /* --- Modals --- */
        .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); backdrop-filter: blur(8px); z-index: 1000; display: none; align-items: center; justify-content: center; padding: 20px; }
        
        .modal { background: var(--bg-surface); border: 1px solid var(--border-ui); border-radius: var(--radius-lg); width: 100%; max-width: 600px; padding: 32px; position: relative; box-shadow: 0 20px 50px rgba(0,0,0,0.5); animation: modalIn 0.3s ease; display: flex; flex-direction: column; max-height: 90vh; }
        .modal-body-scroll { flex: 1; overflow-y: auto; padding-right: 4px; }
        .modal.modal-xl { max-width: 900px; height: 85vh; padding: 0; overflow: hidden; }
        @keyframes modalIn { from { opacity: 0; transform: translateY(20px) scale(0.95); } to { opacity: 1; transform: translateY(0) scale(1); } }
        @keyframes pulse { 0% { opacity: 0.5; transform: scale(0.95); } 50% { opacity: 1; transform: scale(1.05); } 100% { opacity: 0.5; transform: scale(0.95); } }
        @keyframes glitchText { 0% { transform: translate(0); } 20% { transform: translate(-2px, 2px); } 40% { transform: translate(-2px, -2px); } 60% { transform: translate(2px, 2px); } 80% { transform: translate(2px, -2px); } 100% { transform: translate(0); } }

        .modal-header { margin-bottom: 24px; display: flex; justify-content: space-between; align-items: flex-start; flex-shrink: 0; }
        .modal-title { font-size: 1.5rem; font-weight: 800; color: var(--text-primary); }
        .modal-desc { color: var(--text-secondary); font-size: 0.9rem; }
        .close-btn { background: none; border: none; color: var(--text-muted); font-size: 1.5rem; cursor: pointer; padding: 0 8px; line-height: 1; }
        .close-btn:hover { color: var(--text-primary); }

        /* Wizard */
        .wizard-step { display: none; }
        .wizard-step.active { display: block; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        .choice-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 24px; }
        .choice-btn { background: var(--bg-elevated); border: 1px solid var(--border-ui); padding: 16px; border-radius: var(--radius-md); cursor: pointer; text-align: center; transition: 0.2s; position: relative; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .choice-btn:hover { background: #252530; border-color: var(--text-muted); }
        .choice-btn.selected { border-color: var(--accent-lock); background: rgba(6, 182, 212, 0.1); color: var(--accent-lock); }
        .choice-title { color: var(--text-primary); font-weight: 700; margin-bottom: 4px; }
        .choice-meta { color: var(--text-muted); font-size: 0.75rem; }
        
        .choice-btn.locked { opacity: 0.5; cursor: not-allowed; border-style: dashed; }
        .choice-btn.has-debt-warn { border-color: var(--accent-warn); color: var(--accent-warn); background: rgba(245, 158, 11, 0.05); }
        .choice-btn.has-debt-warn::after { content: "‚ö†Ô∏è ACTIVE DEBT"; position: absolute; top: 4px; right: 4px; font-size: 0.6rem; font-weight: 700; color: var(--accent-warn); }

        /* Goal Selection Chips */
        .goal-chip-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-bottom: 16px; }
        .goal-chip { background: var(--bg-deep); border: 1px solid var(--border-ui); padding: 10px; font-size: 0.7rem; font-weight: 700; color: var(--text-secondary); cursor: pointer; text-align: center; border-radius: var(--radius-sm); transition: 0.2s; }
        .goal-chip:hover { border-color: var(--text-muted); color: var(--text-primary); }
        .goal-chip.selected { background: var(--accent-lock); color: var(--bg-deep); border-color: var(--accent-lock); }
        
        .generated-goal-display { background: var(--bg-deep); padding: 12px; border: 1px dashed var(--border-ui); color: var(--accent-lock); font-family: var(--font-mono); font-size: 0.85rem; margin-bottom: 20px; border-radius: var(--radius-sm); text-align: center; }

        /* Map Styles */
        .map-layout { display: flex; height: 100%; }
        .map-sidebar { width: 250px; background: var(--bg-deep); border-right: 1px solid var(--border-ui); padding: 20px; display: flex; flex-direction: column; gap: 20px; }
        .map-content { flex: 1; padding: 20px; overflow-y: auto; background: var(--bg-surface); }
        .subject-group { border: 1px solid var(--border-ui); border-radius: var(--radius-sm); margin-bottom: 8px; background: var(--bg-elevated); }
        .subject-header { padding: 12px; font-weight: 700; font-size: 0.9rem; display: flex; justify-content: space-between; cursor: pointer; color: var(--text-primary); }
        .subject-chapters { display: none; border-top: 1px solid var(--border-ui); }
        .subject-group.expanded .subject-chapters { display: block; }
        .chapter-item { padding: 10px 16px; border-bottom: 1px solid var(--border-ui); display: flex; justify-content: space-between; cursor: pointer; color: var(--text-secondary); }
        .chapter-item:hover { background: rgba(255,255,255,0.05); color: var(--text-primary); }
        .chapter-item.has-debt { border-left: 3px solid var(--accent-crit); background: rgba(239,68,68,0.05); }

        .log-list { display: flex; flex-direction: column; gap: 8px; font-size: 0.8rem; }
        .log-item { background: var(--bg-elevated); padding: 10px; border-radius: var(--radius-sm); border-left: 2px solid var(--border-ui); cursor: pointer; transition: 0.2s; color: var(--text-secondary); }
        .log-item:hover { background: #252530; transform: translateX(2px); color: var(--text-primary); }

        /* Report Card Grades */
        .grade-badge { font-family: var(--font-mono); font-weight: 900; font-size: 2rem; color: var(--text-primary); }
        .grade-S { color: var(--accent-gold); text-shadow: 0 0 10px rgba(255, 215, 0, 0.4); }
        .grade-A { color: var(--accent-succ); }
        .grade-B { color: var(--accent-lock); }
        .grade-C { color: var(--accent-warn); }
        .grade-F { color: var(--accent-crit); }

        /* Tutorial */
        .tut-slide { display: none; }
        .tut-slide.active { display: block; animation: fadeIn 0.3s; }
        .tut-img { width: 100%; height: 150px; background: var(--bg-elevated); border-radius: var(--radius-md); margin-bottom: 20px; display: flex; align-items: center; justify-content: center; font-size: 3rem; color: var(--accent-lock); border: 1px dashed var(--border-ui); }

        /* Onboarding Styles */
        .onboard-card { background: var(--bg-elevated); border: 1px solid var(--border-ui); border-radius: var(--radius-md); padding: 15px; margin-bottom: 15px; }
        .exam-selector { display: flex; align-items: center; justify-content: space-between; padding: 10px; border-bottom: 1px solid var(--border-ui); }
        .exam-selector:last-child { border-bottom: none; }
        .exam-label { display: flex; align-items: center; gap: 10px; font-weight: 700; color: var(--text-primary); }
        .checkbox-custom { width: 20px; height: 20px; accent-color: var(--accent-lock); }
        
        .resource-tag { display: inline-block; padding: 8px 12px; border: 1px solid var(--border-ui); border-radius: 20px; font-size: 0.75rem; color: var(--text-secondary); margin: 4px; cursor: pointer; transition: 0.2s; background: var(--bg-deep); }
        .resource-tag.selected { background: var(--accent-lock); color: var(--bg-deep); border-color: var(--accent-lock); font-weight: 700; }

        #integrity-toast { position: fixed; bottom: 32px; right: 32px; background: var(--accent-crit); color: white; padding: 16px 24px; border-radius: var(--radius-md); font-weight: 800; font-size: 0.85rem; display: none; z-index: 10000; box-shadow: 0 10px 30px rgba(0,0,0,0.5); animation: slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1); }
        @keyframes slideUp { from { transform: translateY(100%); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        
        /* --- INTEGRITY PING ELEMENT --- */
        #integrity-ping-box {
            position: absolute; width: 60px; height: 60px;
            background: rgba(6, 182, 212, 0.2); border: 2px solid var(--accent-lock);
            border-radius: var(--radius-sm); z-index: 50;
            display: none; cursor: crosshair;
            box-shadow: 0 0 15px var(--accent-lock);
            animation: pingPulse 0.5s infinite;
        }
        @keyframes pingPulse { 0% { opacity: 0.8; transform: scale(1); } 50% { opacity: 1; transform: scale(1.1); } 100% { opacity: 0.8; transform: scale(1); } }

        /* Market Item */
        .market-item {
            background: var(--bg-elevated); border: 1px solid var(--border-ui);
            padding: 16px; border-radius: var(--radius-md); margin-bottom: 12px;
            display: flex; justify-content: space-between; align-items: center;
        }
        .market-item:hover { border-color: var(--accent-gold); }
        .xp-cost { font-family: var(--font-mono); font-weight: 700; color: var(--accent-gold); }

        /* Hard Focus Mode */
        body.mode-hard-focus .focus-container { border-color: var(--accent-crit); background: #080505; }
        body.mode-hard-focus #timer-display { color: var(--accent-crit); text-shadow: 0 0 30px rgba(239, 68, 68, 0.3); }
        body.mode-hard-focus .sidebar, body.mode-hard-focus nav, body.mode-hard-focus .bottom-nav { opacity: 0; pointer-events: none; transition: opacity 0.5s; }
        body.mode-hard-focus main { grid-template-columns: 1fr; }
        body.mode-hard-focus .sidebar { display: none; }

        input, select, textarea { width: 100%; background: var(--bg-deep); border: 1px solid var(--border-ui); color: var(--text-primary); padding: 10px; border-radius: var(--radius-sm); margin-bottom: 10px; font-family: inherit; }
        textarea:focus, input:focus { outline: 1px solid var(--accent-lock); border-color: transparent; }
        input::placeholder { color: var(--text-muted); }

        /* --- MOBILE BOTTOM NAVIGATION (NEW) --- */
        .bottom-nav {
            display: none; /* Hidden on desktop */
            position: fixed;
            bottom: 0; left: 0; right: 0;
            height: var(--mobile-nav-height);
            background: var(--bg-deep);
            border-top: 1px solid var(--border-ui);
            z-index: 900;
            justify-content: space-around;
            align-items: center;
            padding-bottom: env(safe-area-inset-bottom);
        }
        .nav-tab {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            color: var(--text-muted);
            font-size: 0.65rem;
            font-weight: 700;
            background: none; border: none;
            width: 100%; height: 100%;
        }
        .nav-tab.active { color: var(--accent-lock); }
        .nav-tab svg { margin-bottom: 4px; }
        
        /* URGENCY COLORS */
        .urgency-crit { border-left: 4px solid var(--accent-crit); background: rgba(239, 68, 68, 0.05); }
        .urgency-high { border-left: 4px solid var(--accent-warn); background: rgba(245, 158, 11, 0.05); }
        .urgency-med { border-left: 4px solid var(--accent-lock); background: rgba(6, 182, 212, 0.05); }

        /* --- MOBILE FIELD OPERATOR DISPLAY (REVISED) --- */
        @media (max-width: 1024px) {
            /* Layout Adjustments */
            body { overflow: hidden; }
            #app-container { height: calc(100vh - var(--mobile-nav-height)); }
            main, main.sidebar-collapsed { 
                grid-template-columns: 1fr !important; 
                gap: 0; 
                padding: 10px; 
                height: 100%;
                overflow-y: auto;
            }
            
            /* Hide Desktop Elements */
            .sidebar-toggle { display: none; }
            nav { padding: 0 12px; }
            .nav-logo { font-size: 1rem; }
            
            /* Show Mobile Elements */
            .bottom-nav { display: flex; }
            
            /* Tab Logic CSS */
            .sidebar { 
                display: none; /* Controlled by JS Tabs */
                min-width: 100%; 
                padding: 0; 
                margin-bottom: 80px; /* Space for nav */
                border: none;
                opacity: 1 !important;
                pointer-events: auto !important;
            }
            .stage { 
                display: none; /* Controlled by JS Tabs */
                height: 100%;
            }
            
            /* Active State overrides */
            .mobile-tab-active { display: flex !important; animation: fadeIn 0.2s; }
            
            /* Adjustments for Mobile View */
            #timer-display { font-size: 20vw; }
            .controls { flex-direction: column; width: 100%; gap: 10px; }
            .controls .btn { width: 100%; height: 56px; font-size: 1rem; }
            
            .modal { padding: 20px; max-height: 95vh; width: 95%; }
            .goal-chip-grid { grid-template-columns: repeat(2, 1fr); }
            .choice-grid { grid-template-columns: 1fr; }
            .custom-time-input { grid-column: span 1; }
            
            /* Map Overlay Mobile Fixes */
            .map-layout { flex-direction: column; }
            .map-sidebar { width: 100%; border-right: none; border-bottom: 1px solid var(--border-ui); height: auto; max-height: 30vh; overflow-y: auto;}
            .map-content { flex: 1; }
            
            /* Toast Position */
            #integrity-toast { bottom: 80px; left: 16px; right: 16px; width: auto; text-align: center; }
        }
    </style>
</head>
<body>

    <div id="app-container">
        <!-- HEADER -->
        <nav>
            <div class="nav-left">
                <button class="sidebar-toggle" onclick="UI.toggleSidebar()">‚ò∞</button>
                <div class="nav-logo">RANKLOCK <span>v9.4</span></div>
            </div>
            <div class="nav-right">
                <div class="stat-item">
                    <div class="stat-label">Wallet (XP)</div>
                    <div class="stat-value tabular" style="color:var(--accent-gold);" id="stat-xp">0</div>
                </div>
                <!-- GLOBAL SYSTEM INTEGRITY -->
                <div class="stat-item">
                    <div class="stat-label" id="top-stat-label">Sys. Integrity</div>
                    <div class="stat-value tabular integrity-ok" id="stat-global-integrity">100%</div>
                </div>
                <!-- FULLSCREEN TOGGLE -->
                <button class="icon-btn" onclick="Logic.System.toggleFullscreen()" title="Fullscreen (F)">
                    <svg viewBox="0 0 24 24" width="18" height="18" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"><path d="M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3"></path></svg>
                </button>
                <button class="icon-btn" onclick="UI.openSettings()">‚öô</button>
            </div>
        </nav>

        <main id="main-layout" class="sidebar-collapsed"> 
            <!-- SIDEBAR (INTEL TAB ON MOBILE) -->
            <aside class="sidebar" id="sidebar">
                <div class="card">
                    <div class="card-header">
                        <span class="card-title">System Rank</span>
                        <button style="font-size:0.6rem; background: var(--bg-elevated); border:1px solid var(--border-ui); color:var(--text-secondary); cursor:pointer; padding:2px 6px;" onclick="UI.openMarket()">OPEN MARKET</button>
                    </div>
                    <div class="rank-box">
                        <div class="rank-value tabular" id="display-rank">0</div>
                        <div class="rank-label" id="display-rank-title">UNINITIATED</div>
                        <div class="rank-perk-badge" id="rank-perk-badge">NEXT: HARD FOCUS</div>
                        <div class="rank-progress"><div class="rank-bar" id="rank-bar-fill"></div></div>
                        <div style="font-size: 0.65rem; color: var(--text-muted); margin-top: 4px; text-align: right;" id="rank-next-val">NEXT: 500 XP</div>
                    </div>
                </div>
                
                <!-- Desktop Map Button -->
                <div class="card" id="desktop-map-card">
                    <div class="card-header"><span class="card-title">Syllabus Map</span></div>
                    <div style="text-align: center; padding: 10px 0;">
                        <div style="font-size: 0.8rem; color: var(--text-secondary); margin-bottom: 4px;" id="map-summary-text">System Idle</div>
                        <div style="font-size: 0.7rem; color: var(--text-muted); margin-bottom: 15px;" id="stat-daily-quality">0h 0m Focus</div>
                        <button class="btn btn-outline btn-block" onclick="UI.openMap()">OPEN COMMAND CENTER</button>
                    </div>
                </div>
                
                <!-- Desktop Events Button -->
                <div class="card hidden" id="desktop-events-card">
                    <button class="btn btn-primary btn-block" onclick="UI.openEvents()">MANAGE EVENTS</button>
                </div>

                <div class="card" style="flex:1; max-height: 300px;">
                    <div class="card-header">
                        <span class="card-title">Active Debts</span>
                        <span id="debt-count" style="color: var(--accent-crit); font-weight: 700;">0m</span>
                    </div>
                    <div class="log-list" id="debt-list" style="overflow-y: auto;"></div>
                </div>
                <div class="card">
                    <div class="card-header"><span class="card-title">Recent Logs</span></div>
                    <div class="log-list" id="recent-logs-container"></div>
                </div>
                <div class="architect-tag">DESIGNED BY OJAS KADAM</div>
            </aside>

            <!-- STAGE (OPS TAB ON MOBILE) -->
            <section class="stage" id="stage">
                <div class="focus-container">
                    <div class="focus-bg-pulse"></div>
                    
                    <!-- Overlays -->
                    <div id="integrity-visual-overlay"></div>
                    <div id="integrity-ping-box" onclick="Logic.Session.handlePingSuccess()"></div>
                    <div id="countdown-overlay">
                        <div class="countdown-val" id="countdown-val">3</div>
                        <div class="countdown-label">Visualize</div>
                    </div>
                    
                    <!-- SESSION INTEGRITY BADGE -->
                    <div class="session-integrity-badge" id="session-integrity-badge">
                        <span style="font-size:0.7rem; color:var(--text-muted);">SESSION LOCK</span><br>
                        <span id="session-integrity-val" style="font-size:1.2rem; color:var(--accent-succ);">100%</span>
                    </div>

                    <div class="session-context" id="active-session-meta">
                        <div class="context-subject">SYSTEM IDLE</div>
                        <div class="context-chapter">Ready for initialization</div>
                    </div>

                    <div id="timer-display" class="tabular">00:00</div>

                    <div class="controls" id="session-controls">
                        <button class="btn btn-primary" id="btn-init-session">INITIALIZE SESSION</button>
                        <button class="btn btn-outline hidden" id="btn-pause-session">PAUSE</button>
                        <button class="btn btn-crit hidden" id="btn-emergency-exit">ABORT</button>
                    </div>
                </div>
            </section>
        </main>
        
        <!-- MOBILE BOTTOM NAV -->
        <div class="bottom-nav">
            <button class="nav-tab active" onclick="UI.switchMobileTab('ops')">
                <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>
                OPS
            </button>
            <button class="nav-tab" onclick="UI.switchMobileTab('intel')">
                <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M18 20V10M12 20V4M6 20v-6"></path></svg>
                INTEL
            </button>
            <button class="nav-tab" onclick="UI.switchMobileTab('map')">
                <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><polygon points="1 6 1 22 8 18 16 22 23 18 23 2 16 6 8 2 1 6"></polygon><line x1="8" y1="2" x2="8" y2="18"></line><line x1="16" y1="6" x2="16" y2="22"></line></svg>
                MAP
            </button>
            <!-- REPLACED COMMS WITH EVENTS -->
            <button class="nav-tab" onclick="UI.openEvents()">
                <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>
                EVENTS
            </button>
        </div>
    </div>

    <!-- OVERLAY: WIZARD -->
    <div id="overlay-setup" class="overlay">
        <div class="modal">
            <div class="modal-header">
                <div><h2 class="modal-title">Protocol Configuration</h2><p class="modal-desc">Define session parameters.</p></div>
                <button class="close-btn" onclick="UI.closeOverlays()">√ó</button>
            </div>
            
            <!-- Scrollable Content -->
            <div class="modal-body-scroll">
                
                <!-- STEP 1: SUBJECT -->
                <div class="wizard-step active" id="step-subject">
                    <div class="form-label" style="margin-bottom:10px; font-weight:700; color:var(--text-secondary);">SELECT DOMAIN</div>
                    <div class="choice-grid" id="setup-subject-grid"></div>
                </div>
                
                <!-- STEP 2: CHAPTER -->
                <div class="wizard-step" id="step-chapter">
                    <div class="form-label" style="margin-bottom:10px; font-weight:700; color:var(--text-secondary);">SELECT CHAPTER</div>
                    <div class="choice-grid" id="setup-chapter-grid"></div>
                    <button class="btn btn-outline btn-sm" onclick="UI.wizardBack()" style="margin-top:10px; width:100%;">BACK</button>
                </div>
                
                <!-- STEP 3: INTENSITY & MISSION -->
                <div class="wizard-step" id="step-mode">
                    <div style="background: var(--bg-elevated); padding: 12px; border-radius: 8px; margin-bottom: 20px; border-left: 3px solid var(--accent-lock);">
                        <div style="font-size:0.7rem; color:var(--text-muted); uppercase;">TARGET LOCK</div>
                        <div style="font-size:1rem; font-weight:700; color:var(--text-primary);" id="wizard-target-display">Physics - Mechanics</div>
                    </div>
                    
                    <div class="form-label" style="margin-bottom:10px; font-weight:700; color:var(--text-secondary);">MISSION PROTOCOL</div>
                    <div class="goal-chip-grid" id="goal-type-grid">
                        <div class="goal-chip" onclick="Logic.UI.setGoalType(this, 'LEARN')">LEARN</div>
                        <div class="goal-chip" onclick="Logic.UI.setGoalType(this, 'PRACTICE')">PRACTICE</div>
                        <div class="goal-chip" onclick="Logic.UI.setGoalType(this, 'REVISE')">REVISE</div>
                        <div class="goal-chip" onclick="Logic.UI.setGoalType(this, 'TEST')">TEST</div>
                    </div>
                    
                    <div class="form-label" style="margin-bottom:10px; font-weight:700; color:var(--text-secondary);">RESOURCE</div>
                    <div class="goal-chip-grid" id="goal-resource-grid">
                        <!-- Populated dynamically by User Preference -->
                    </div>

                    <div class="form-label" style="margin-bottom:10px; font-weight:700; color:var(--text-secondary);">SCOPE (OPTIONAL)</div>
                    <input type="text" id="goal-scope-input" placeholder="e.g. Q1-Q30 or Pg 50-60" oninput="Logic.UI.updateGoalDisplay()" maxlength="30" style="margin-bottom: 10px;">

                    <div class="generated-goal-display" id="generated-goal-text">SELECT PROTOCOL</div>

                    <div class="form-label" style="margin-bottom:10px; font-weight:700; color:var(--text-secondary);">INTENSITY</div>
                    <div class="choice-grid">
                        <div class="choice-btn selected" data-mode="normal" onclick="Logic.UI.selectMode('normal')">
                            <span class="choice-title">NORMAL</span><span class="choice-meta">Pause allowed.</span>
                        </div>
                        <div class="choice-btn" id="btn-mode-hard" data-mode="hard" onclick="Logic.UI.selectMode('hard')">
                            <span class="choice-title" style="color:var(--accent-crit)">HARD FOCUS</span>
                            <span class="choice-meta" id="hard-mode-meta">No pause. Fullscreen.</span>
                        </div>
                        <div class="choice-btn hidden" id="btn-mode-debt" data-mode="debt" onclick="Logic.UI.selectMode('debt')">
                            <span class="choice-title" style="color:var(--accent-warn)">DEBT CLEARANCE</span>
                            <span class="choice-meta">Repay Active Time.</span>
                        </div>
                    </div>

                    <div class="form-label" style="margin-bottom:10px; font-weight:700; color:var(--text-secondary);">DURATION (MINS)</div>
                    <div class="choice-grid" style="grid-template-columns: repeat(4, 1fr);">
                        <div class="choice-btn" data-dur="25" onclick="Logic.UI.selectDuration(25)">25m</div>
                        <div class="choice-btn" data-dur="50" onclick="Logic.UI.selectDuration(50)">50m</div>
                        <div class="choice-btn" data-dur="90" onclick="Logic.UI.selectDuration(90)">90m</div>
                        <input type="number" id="custom-time-input" class="custom-time-input" placeholder="1-600" min="1" max="600" oninput="Logic.UI.selectDuration('custom')" onfocus="Logic.UI.selectDuration('custom')">
                    </div>

                    <div class="flex" style="display: flex; justify-content: space-between; gap: 10px; margin-top: 2rem; padding-bottom: 10px;">
                        <button class="btn btn-outline" style="flex:1" onclick="UI.wizardBack()">BACK</button>
                        <button class="btn btn-primary" style="flex:2" id="btn-setup-launch">INITIATE</button>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <!-- OVERLAY: MAP -->
    <div id="overlay-map" class="overlay">
        <div class="modal modal-xl">
            <div class="map-layout">
                <div class="map-sidebar">
                    <div><h2 style="font-size: 1.2rem; color: var(--text-primary);">Command Center</h2><p style="font-size: 0.8rem; color: var(--text-muted);">Manage syllabus & debts.</p></div>
                    <div style="flex: 1;"></div>
                    <div>
                        <div style="font-size: 0.7rem; font-weight: 700; color: var(--text-muted); margin-bottom: 8px;">ADD TO DATABASE</div>
                        <input type="text" id="new-subject-input" placeholder="New Subject Name">
                        <button class="btn btn-outline btn-block" onclick="Logic.UI.addSubject()" style="margin-bottom: 12px; font-size: 0.75rem;">+ ADD SUBJECT</button>
                        <div style="border-top: 1px solid var(--border-ui); margin: 12px 0;"></div>
                        <select id="manager-subject-select"></select>
                        <input type="text" id="new-chapter-input" placeholder="New Chapter Name">
                        <button class="btn btn-outline btn-block" onclick="Logic.UI.addChapter()" style="font-size: 0.75rem;">+ ADD CHAPTER</button>
                    </div>
                    <button class="btn btn-outline" onclick="UI.closeOverlays()">CLOSE MAP (ESC)</button>
                </div>
                <div class="map-content"><div id="map-accordion-container"></div></div>
            </div>
        </div>
    </div>
    
    <!-- OVERLAY: EVENTS -->
    <div id="overlay-events" class="overlay">
        <div class="modal">
            <div class="modal-header">
                <div>
                    <h2 class="modal-title">Temporal Engine</h2>
                    <p class="modal-desc">Track deadlines. Manage urgency.</p>
                </div>
                <button class="close-btn" onclick="UI.closeOverlays()">√ó</button>
            </div>
            <div class="modal-body-scroll" id="events-container">
                <!-- Injected via JS -->
            </div>
            <div style="border-top: 1px solid var(--border-ui); padding-top: 16px; margin-top: 16px;">
                <div style="font-size:0.7rem; color:var(--text-muted); font-weight:700; margin-bottom:8px;">ADD CUSTOM EVENT</div>
                <div style="display:flex; gap:10px; flex-wrap:wrap;">
                    <input type="text" id="new-event-name" placeholder="Name (e.g. Mock Test 1)" style="flex:1; margin:0;">
                    <input type="date" id="new-event-date" style="flex:1; margin:0; background:var(--bg-elevated);">
                    <button class="btn btn-primary" onclick="Logic.Onboarding.addCustomEvent()">ADD</button>
                </div>
            </div>
        </div>
    </div>

    <!-- OVERLAY: MARKET (NEW) -->
    <div id="overlay-market" class="overlay">
        <div class="modal">
            <div class="modal-header">
                <div><h2 class="modal-title">The Black Market</h2><p class="modal-desc">Spend XP. Survive.</p></div>
                <button class="close-btn" onclick="UI.closeOverlays()">√ó</button>
            </div>
            <div style="text-align: center; margin-bottom: 20px; padding: 10px; background: var(--bg-elevated); border-radius: var(--radius-md);">
                <div style="font-size: 0.8rem; color: var(--text-secondary);">AVAILABLE FUNDS</div>
                <div style="font-size: 2rem; font-weight: 900; color: var(--accent-gold); font-family: var(--font-mono);" id="market-balance">0</div>
            </div>
            <div id="market-listings">
                <!-- Injected -->
            </div>
        </div>
    </div>

    <!-- OVERLAY: ONBOARDING -->
    <div id="overlay-onboarding" class="overlay" style="z-index: 2200;">
        <div class="modal" style="max-width: 500px;">
            <!-- Philosophy Slide -->
            <div class="tut-slide active" id="onboard-step-0">
                <div style="text-align: center; margin-bottom: 30px;">
                    <div style="font-size: 3rem; margin-bottom: 10px;">üß†</div>
                    <h2 class="modal-title">Entry Philosophy</h2>
                    <p class="modal-desc" style="margin-top:10px;">
                        This is not just a timer.<br>
                        It is a war room for your ambition.<br>
                        Configure your battlefield to begin.
                    </p>
                </div>
                <button class="btn btn-primary btn-block" onclick="Logic.Onboarding.next(1)">CONFIGURE PROTOCOL (3 MINS)</button>
            </div>

            <!-- Step 1: Exam Selection -->
            <div class="tut-slide" id="onboard-step-1">
                <h2 class="modal-title">Identity Protocol</h2>
                <p class="modal-desc" style="margin-bottom: 20px;">Select your primary battlefield. This is unskippable.</p>
                
                <div class="onboard-card">
                    <div class="exam-selector">
                        <label class="exam-label"><input type="checkbox" class="checkbox-custom" value="JEE Main"> JEE Main</label>
                        <input type="radio" name="primary_exam" value="JEE Main">
                    </div>
                    <div class="exam-selector">
                        <label class="exam-label"><input type="checkbox" class="checkbox-custom" value="JEE Advanced"> JEE Advanced</label>
                        <input type="radio" name="primary_exam" value="JEE Advanced">
                    </div>
                    <div class="exam-selector">
                        <label class="exam-label"><input type="checkbox" class="checkbox-custom" value="NEET"> NEET</label>
                        <input type="radio" name="primary_exam" value="NEET">
                    </div>
                    <div class="exam-selector">
                        <label class="exam-label"><input type="checkbox" class="checkbox-custom" value="Boards"> Boards (12th)</label>
                        <input type="radio" name="primary_exam" value="Boards">
                    </div>
                    <div class="exam-selector">
                        <label class="exam-label"><input type="checkbox" class="checkbox-custom" value="Other"> Other</label>
                        <input type="radio" name="primary_exam" value="Other">
                    </div>
                    <div style="text-align: right; padding: 8px; font-size: 0.7rem; color: var(--text-muted);">Select Radio for Primary Target</div>
                </div>
                
                <button class="btn btn-primary btn-block" onclick="Logic.Onboarding.validateExam()">CONFIRM IDENTITY</button>
            </div>

            <!-- Step 2: Dates -->
            <div class="tut-slide" id="onboard-step-2">
                <h2 class="modal-title">Temporal Data</h2>
                <p class="modal-desc" style="margin-bottom: 20px;">When is D-Day? Skip if unknown.</p>
                <div id="onboard-date-container"></div>
                <button class="btn btn-primary btn-block" style="margin-top: 20px;" onclick="Logic.Onboarding.next(3)">NEXT</button>
            </div>

            <!-- Step 3: Resources -->
            <div class="tut-slide" id="onboard-step-3">
                <h2 class="modal-title">Arsenal Inventory</h2>
                <p class="modal-desc" style="margin-bottom: 20px;">What weapons do you actually use?</p>
                
                <div style="background: var(--bg-elevated); padding: 20px; border-radius: 8px; border: 1px solid var(--border-ui); margin-bottom: 20px;">
                    <div id="resource-tags-container">
                        <span class="resource-tag selected" onclick="this.classList.toggle('selected')">Coaching Modules</span>
                        <span class="resource-tag selected" onclick="this.classList.toggle('selected')">NCERT</span>
                        <span class="resource-tag selected" onclick="this.classList.toggle('selected')">PYQs</span>
                        <span class="resource-tag" onclick="this.classList.toggle('selected')">H.C. Verma</span>
                        <span class="resource-tag" onclick="this.classList.toggle('selected')">Reference Books</span>
                        <span class="resource-tag" onclick="this.classList.toggle('selected')">Lecture Notes</span>
                        <span class="resource-tag" onclick="this.classList.toggle('selected')">YouTube</span>
                        <span class="resource-tag" onclick="this.classList.toggle('selected')">Test Series</span>
                    </div>
                    <input type="text" id="custom-resource-input" placeholder="+ Add Custom Resource" style="margin-top: 15px; background: var(--bg-deep);" onkeydown="if(event.key === 'Enter') Logic.Onboarding.addCustomResource(this)">
                </div>

                <button class="btn btn-primary btn-block" onclick="Logic.Onboarding.finish()">INITIALIZE SYSTEM</button>
                <div style="margin-top: 15px; font-size: 0.7rem; color: var(--text-muted); text-align: center;">
                    Disclaimer: You can add custom subjects and modify resources later in the System Map.
                </div>
            </div>
        </div>
    </div>

    <!-- OVERLAY: COMMS (FEEDBACK) -->
    <div id="overlay-comms" class="overlay">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title">Comms Uplink</h2>
                <button class="close-btn" onclick="UI.closeOverlays()">√ó</button>
            </div>
            <p class="modal-desc" style="margin-bottom: 20px;">Direct line to Ojas Kadam (Architect). Report bugs or request features.</p>
            
            <iframe name="hidden_iframe" id="hidden_iframe" style="display:none;" onload="if(typeof submitted !== 'undefined' && submitted) {UI.commsSuccess()}"></iframe>
            
            <form action="https://formsubmit.co/okwarrior.2456@gmail.com" method="POST" target="hidden_iframe" onsubmit="window.submitted=true;">
                <input type="hidden" name="_subject" value="RANKLOCK V9 FEEDBACK">
                <input type="hidden" name="_captcha" value="false">
                <input type="hidden" name="_template" value="table">
                
                <div class="form-group" style="margin-bottom: 15px;">
                    <label class="form-label" style="font-size:0.7rem; color:var(--text-muted); font-weight:700;">USER IDENTITY</label>
                    <input type="text" name="name" id="comms-name" readonly style="background: var(--bg-elevated); color: var(--text-secondary); cursor: not-allowed;">
                </div>
                
                <div class="form-group" style="margin-bottom: 15px;">
                    <label class="form-label" style="font-size:0.7rem; color:var(--text-muted); font-weight:700;">MESSAGE TYPE</label>
                    <select name="type">
                        <option value="Feature Request">Feature Request</option>
                        <option value="Bug Report">Bug Report</option>
                        <option value="General Feedback">General Feedback</option>
                    </select>
                </div>
                
                <div class="form-group" style="margin-bottom: 20px;">
                    <label class="form-label" style="font-size:0.7rem; color:var(--text-muted); font-weight:700;">TRANSMISSION CONTENT</label>
                    <textarea name="message" rows="5" placeholder="Type your message here..." required></textarea>
                </div>
                
                <button type="submit" class="btn btn-primary btn-block">TRANSMIT DATA</button>
            </form>
        </div>
    </div>

    <!-- OVERLAY: AUTOPSY (GENERATIVE REPORT) -->
    <div id="overlay-autopsy" class="overlay">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title">System Evaluation</h2>
            </div>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                <div style="background: var(--bg-elevated); padding: 16px; border-radius: var(--radius-md); text-align: center;">
                    <div style="font-size: 0.7rem; color: var(--text-muted); font-weight: 700; margin-bottom: 8px;">SYSTEM GRADE</div>
                    <div class="grade-badge" id="auto-grade-display">-</div>
                    <div id="auto-analysis-text" style="font-size: 0.65rem; color: var(--text-secondary); margin-top: 8px; font-weight: 700; letter-spacing: 0.05em; text-transform: uppercase;">ANALYZING...</div>
                </div>
                <div style="background: var(--bg-elevated); padding: 16px; border-radius: var(--radius-md); font-size: 0.8rem; display: flex; flex-direction: column; justify-content: center; gap: 4px;">
                    <div style="display: flex; justify-content: space-between;"><span>INTEGRITY:</span> <span id="auto-integrity-display" style="font-weight: 700;">-</span></div>
                    <div style="display: flex; justify-content: space-between;"><span>DURATION:</span> <span id="auto-duration-display" style="font-weight: 700;">-</span></div>
                    <div style="display: flex; justify-content: space-between;"><span>EFFICIENCY:</span> <span id="auto-efficiency-display" style="font-weight: 700;">-</span></div>
                    <div style="border-top: 1px dashed var(--border-ui); margin: 6px 0;"></div>
                    <div style="display: flex; justify-content: space-between; color: var(--accent-lock);"><span>EARNINGS:</span> <span id="auto-xp-display" style="font-weight: 700;">-</span></div>
                </div>
            </div>

            <div class="form-group" style="margin-bottom: 20px;">
                <label class="form-label" style="display:block; font-size:0.75rem; color:var(--text-secondary); margin-bottom:8px;">KNOWLEDGE CRYSTALLIZATION (REQUIRED)</label>
                <textarea id="autopsy-summary" rows="3" placeholder="What concept was mastered? Be specific. Input required to exit." oninput="UI.validateAutopsy()"></textarea>
            </div>
            <div class="form-group" style="margin-bottom: 20px;">
                <label class="form-label" style="display:block; font-size:0.75rem; color:var(--text-secondary); margin-bottom:8px;">MISTAKE ANALYSIS</label>
                <div style="display: flex; gap: 10px;">
                    <button class="choice-btn selected" id="autopsy-mistake-no" onclick="UI.toggleMistake(false)" style="flex: 1">CLEAN RUN</button>
                    <button class="choice-btn" id="autopsy-mistake-yes" onclick="UI.toggleMistake(true)" style="flex: 1; border-color: var(--accent-crit); color: var(--accent-crit);">MISTAKES FOUND</button>
                </div>
            </div>
            
            <button class="btn btn-primary" style="width: 100%;" id="btn-autopsy-submit" disabled>COMMIT LOG</button>
        </div>
    </div>

    <!-- OVERLAY: LOG DETAILS -->
    <div id="overlay-log-details" class="overlay">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title">Session Archive</h2>
                <button class="close-btn" onclick="UI.closeOverlays()">√ó</button>
            </div>
            <div id="log-details-content">
                <!-- Injected via JS -->
            </div>
        </div>
    </div>

    <!-- OVERLAY: USERNAME SETUP (UNSKIPPABLE) -->
    <div id="overlay-username" class="overlay" style="z-index: 2100; pointer-events: auto;">
        <div class="modal" style="max-width: 450px; text-align: center;">
            <div class="modal-header" style="justify-content: center;">
                <h2 class="modal-title">Identity Registration</h2>
            </div>
            <p class="modal-desc" style="margin-bottom: 20px;">Enter your designation for the Ranklock System.</p>
            <input type="text" id="input-username" placeholder="Enter Your Name" maxlength="20" style="text-align: center; font-size: 1.2rem; font-weight: 700; color: var(--accent-lock); margin-bottom: 20px;">
            <button class="btn btn-primary btn-block" onclick="Logic.System.setUsername()">CONFIRM IDENTITY</button>
        </div>
    </div>

    <!-- OVERLAY: TUTORIAL -->
    <div id="overlay-tutorial" class="overlay" style="z-index: 2300;">
        <div class="modal" style="max-width: 500px; text-align: center;">
            <div class="tut-slide active" id="tut-step-1">
                <div class="tut-img">üöÄ</div>
                <h2 class="modal-title">System Online</h2>
                <p class="modal-desc">RankLock v9.4 Initialized. Welcome to the discipline protocol.</p>
                <button class="btn btn-primary btn-block" style="margin-top: 30px;" onclick="Logic.Tutorial.next(2)">NEXT: INTEGRITY</button>
            </div>
            <div class="tut-slide" id="tut-step-2">
                <div class="tut-img" style="color: var(--accent-crit); border-color: var(--accent-crit);">üõ°Ô∏è</div>
                <h2 class="modal-title">Dual Integrity</h2>
                <p class="modal-desc">
                    <strong>Global Integrity:</strong> Your Account Health. Can be repaired by high grades (S/A/B).<br><br>
                    <strong>Session Integrity:</strong> Focus quality. Tab switching = -20%.
                </p>
                <button class="btn btn-primary btn-block" style="margin-top: 30px;" onclick="Logic.Tutorial.next(3)">NEXT: MISSIONS</button>
            </div>
            <div class="tut-slide" id="tut-step-3">
                <div class="tut-img" style="color: var(--accent-lock);">üéØ</div>
                <h2 class="modal-title">Strategic Protocols</h2>
                <p class="modal-desc">
                    Do not just "study". Select a <strong>Protocol</strong> (Learn, Practice) and a <strong>Resource</strong>.
                    <br><br>Be specific. Vague goals are weakness.
                </p>
                <button class="btn btn-primary btn-block" style="margin-top: 30px;" onclick="Logic.Tutorial.next(4)">NEXT: DEBTS</button>
            </div>
            <div class="tut-slide" id="tut-step-4">
                <div class="tut-img" style="color: var(--accent-warn); border-color: var(--accent-warn);">‚ö†Ô∏è</div>
                <h2 class="modal-title">Time Debt</h2>
                <p class="modal-desc">
                    Leaving a session early creates <strong>Time Debt</strong>.<br>
                    Active Debt applies a <strong>50% Tax</strong> on all XP earnings.<br><br>
                    <strong>To Clear:</strong> Use "Debt Clearance" mode. No shortcuts.
                </p>
                <button class="btn btn-primary btn-block" style="margin-top: 30px;" onclick="Logic.Tutorial.next(5)">NEXT: FOCUS</button>
            </div>
            <div class="tut-slide" id="tut-step-5">
                <div class="tut-img" style="color: var(--accent-crit);">üîí</div>
                <h2 class="modal-title">Hard Focus</h2>
                <p class="modal-desc">
                    Unlocked at Rank 500 (Aspirant). <br>
                    No Pause. Sidebar Hidden. Fullscreen Mode.<br>
                    <br><strong>Begin your ascent.</strong>
                </p>
                <button class="btn btn-primary btn-block" style="margin-top: 30px;" onclick="Logic.Tutorial.finish()">INITIALIZE SYSTEM</button>
            </div>
        </div>
    </div>

    <!-- SETTINGS -->
    <div id="overlay-settings" class="overlay">
        <div class="modal" style="max-width: 400px; text-align: center;">
            <div class="modal-header" style="justify-content: center;"><h2 class="modal-title">System Settings</h2></div>
            
            <div style="border-top: 1px solid var(--border-ui); margin: 20px 0; padding-top: 20px;">
                <div style="font-size:0.7rem; color:var(--text-muted); margin-bottom:10px; font-weight:700;">DATA PERSISTENCE</div>
                <button class="btn btn-outline" onclick="Logic.System.exportData()" style="width: 100%; margin-bottom: 10px;">BACKUP DATA (JSON)</button>
                <button class="btn btn-outline" onclick="document.getElementById('import-file').click()" style="width: 100%; margin-bottom: 10px;">RESTORE DATA</button>
                <input type="file" id="import-file" class="file-input" accept=".json" onchange="Logic.System.importData(this)" style="display:none;">
            </div>
            
            <button class="btn btn-outline" onclick="UI.openComms()" style="width: 100%; margin-bottom: 10px;">FEEDBACK / REPORT BUG</button>
            <button class="btn btn-primary" onclick="Logic.Tutorial.restart()" style="width: 100%; margin-bottom: 10px;">SYSTEM MANUAL (TUTORIAL)</button>

            <div style="margin: 20px 0;">
                <div style="font-size:0.7rem; color:var(--text-muted); margin-bottom:5px;">ARCHITECT</div>
                <div style="font-weight: 700; color: var(--text-secondary);">OJAS KADAM</div>
            </div>

            <button class="btn btn-crit" onclick="Logic.System.factoryReset()" style="width: 100%">SYSTEM PURGE (RESET)</button>
            <button class="btn btn-outline" onclick="UI.closeOverlays()" style="width: 100%; margin-top: 20px;">CLOSE</button>
        </div>
    </div>

    <div id="integrity-toast">INTEGRITY BREACH DETECTED</div>
    
    <!-- JS Logic -->
    <script>
        window.submitted = false;

        const CONSTANTS = {
            VERSION: 9.4,
            APP_ID: "RANKLOCK_JEE_V9_4", 
            RANKS: [
                {t:0, title:"UNINITIATED", perk:"None"},
                {t:500, title:"ASPIRANT", perk:"Hard Focus Unlocked"},
                {t:1500, title:"DISCIPLINE I", perk:"Market Access"},
                {t:4000, title:"DISCIPLINE II", perk:"Entropy Shield I"},
                {t:10000, title:"SCHOLAR", perk:"Entropy Shield II"},
                {t:25000, title:"ELITE", perk:"Max Authority"},
                {t:50000, title:"TOP RANKER", perk:"Legendary"},
                {t:100000, title:"IITIAN", perk:"God Tier"}
            ],
            HARD_MODE_REQ: 500,
            MARKET_REQ: 0,
            DAILY_XP_CAP: 1500,
            
            PRESETS: {
                PHYSICS: { id: 'phys', name: 'PHYSICS', chapters: ['Units & Dimensions', 'Kinematics', 'Laws of Motion', 'Work Energy Power', 'Rotational Motion', 'Gravitation', 'Solids & Fluids', 'Thermodynamics', 'Electrostatics', 'Current Electricity', 'Magnetism', 'EMI & AC', 'Optics', 'Modern Physics'] },
                CHEMISTRY: { id: 'chem', name: 'CHEMISTRY', chapters: ['Mole Concept', 'Atomic Structure', 'Periodic Table', 'Bonding', 'States of Matter', 'Thermodynamics', 'Equilibrium', 'Kinetics', 'Electrochemistry', 'Solutions', 'Metallurgy', 'Block Chemistry', 'Coordination Compounds', 'GOC', 'Hydrocarbons', 'Haloalkanes', 'Oxygen Compounds', 'Nitrogen Compounds', 'Biomolecules'] },
                MATH: { id: 'math', name: 'MATHEMATICS', chapters: ['Sets & Relations', 'Trigonometry', 'Quadratic Eq', 'Complex Numbers', 'P&C', 'Binomial', 'Sequences', 'Straight Lines', 'Circles', 'Conics', 'Limits & Continuity', 'Derivatives', 'Indefinite Integral', 'Definite Integral', 'Diff Equations', 'Vectors & 3D', 'Probability'] },
                BIOLOGY: { id: 'bio', name: 'BIOLOGY', chapters: ['Living World', 'Biological Classification', 'Plant Kingdom', 'Animal Kingdom', 'Morphology', 'Anatomy', 'Structural Org', 'Cell Unit', 'Biomolecules', 'Cell Cycle', 'Transport', 'Mineral Nutrition', 'Photosynthesis', 'Respiration', 'Plant Growth', 'Digestion', 'Breathing', 'Body Fluids', 'Excretory', 'Locomotion', 'Neural Control', 'Chemical Coord', 'Reproduction', 'Genetics', 'Evolution', 'Human Health', 'Microbes', 'Biotech', 'Ecology'] }
            },

            LINKS: {
                "JEE Main": { main: "https://jeemain.nta.ac.in", backup: "https://nta.ac.in" },
                "JEE Advanced": { main: "https://jeeadv.ac.in", backup: "https://jeemain.nta.ac.in" },
                "NEET": { main: "https://neet.nta.nic.in", backup: "https://nta.ac.in" },
                "Boards": { main: "https://cbse.gov.in", backup: "https://ncert.nic.in" },
                "Other": { main: "https://google.com", backup: null }
            }
        };

        let defaultSubjects = [CONSTANTS.PRESETS.PHYSICS, CONSTANTS.PRESETS.CHEMISTRY, CONSTANTS.PRESETS.MATH];

        let State = {
            username: null,
            rank: 0, dailySeconds: 0, 
            dailyXP: 0, 
            chapterStats: {}, subjects: [...defaultSubjects], logs: [], 
            tutorialComplete: false,
            onboardingComplete: false,
            userProfile: { exams: [], resources: [] }, 
            streak: 0, lastLoginDate: null,
            systemIntegrity: 100, 
            session: { active: false, paused: false, mode: 'normal', remaining: 0, total: 0, integrity: 100, goal: '', pauses: 0, lastPauseTime: 0, pingMissed: 0 }
        };

        let goalState = { type: null, resource: null };
        let pingTimer = null;

        const Storage = {
            save: () => localStorage.setItem(CONSTANTS.APP_ID, JSON.stringify(State)),
            load: () => {
                const raw = localStorage.getItem(CONSTANTS.APP_ID);
                if (raw) { 
                    const loaded = JSON.parse(raw);
                    if(!loaded.userProfile) loaded.userProfile = { exams: [], resources: [] };
                    if(loaded.dailyXP === undefined) loaded.dailyXP = 0;
                    State = { ...State, ...loaded }; 
                    return true; 
                }
                const v93 = localStorage.getItem("RANKLOCK_JEE_V9_3");
                if(v93) {
                    try {
                        const v9Data = JSON.parse(v93);
                        State = { ...State, ...v9Data };
                        State.dailyXP = 0;
                        console.log("Migrated from v9.3 to v9.4");
                        Storage.save();
                        return true;
                    } catch(e) { console.error("Migration failed"); }
                }
                return false;
            },
            reset: () => { localStorage.removeItem(CONSTANTS.APP_ID); location.reload(); }
        };

        const Logic = {
            System: {
                init() {
                    Storage.load();
                    if(State.systemIntegrity === undefined) State.systemIntegrity = 100;
                    
                    const today = new Date().toDateString();
                    if(State.lastLoginDate !== today) {
                        State.dailyXP = 0; // Reset Daily Cap
                    }
                    State.lastLoginDate = today;

                    if(State.username) UI.updateUsername(State.username);
                    else {
                        const tempUser = document.querySelector('.user-name-target');
                        if(tempUser) tempUser.textContent = "IDENTIFYING...";
                    }

                    this.checkIntegrityOnLoad();
                    UI.init();
                    
                    if(window.innerWidth > 1024) {
                        document.getElementById('main-layout').classList.remove('sidebar-collapsed');
                        document.getElementById('desktop-events-card').classList.remove('hidden');
                    } else {
                        UI.switchMobileTab('ops');
                    }
                    
                    UI.renderAll();
                    setInterval(() => Logic.Session.tick(), 1000);
                    
                    if(!State.tutorialComplete) {
                        Logic.Tutorial.start();
                    } else if (!State.onboardingComplete) {
                        Logic.Onboarding.start();
                    } else if (!State.username) {
                        Logic.System.showNameModal();
                    }
                    
                    UI.renderUrgency();

                    document.addEventListener('keydown', (e) => {
                        if(e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;
                        if (e.code === 'Space' && State.session.active && State.session.mode === 'normal') { e.preventDefault(); Logic.Session.togglePause(); }
                        if (e.code === 'Escape') {
                            const unOverlay = document.getElementById('overlay-username');
                            const obOverlay = document.getElementById('overlay-onboarding');
                            if ((unOverlay && unOverlay.style.display === 'flex') || (obOverlay && obOverlay.style.display === 'flex')) return;
                            
                            if (State.session.active) { if(confirm("ABORT SESSION?")) Logic.Session.abort(); }
                            else UI.closeOverlays();
                        }
                        if (e.code === 'KeyF') { e.preventDefault(); Logic.System.toggleFullscreen(); }
                    });

                    document.addEventListener('visibilitychange', () => {
                        if (document.hidden && State.session.active && !State.session.paused) Logic.Session.breach("TAB SWITCH");
                    });
                },
                toggleFullscreen() {
                    if (!document.fullscreenElement) {
                        document.documentElement.requestFullscreen().catch((err) => {});
                    } else {
                        if (document.exitFullscreen) document.exitFullscreen();
                    }
                },
                showNameModal() { document.getElementById('overlay-username').style.display = 'flex'; },
                setUsername() {
                    const input = document.getElementById('input-username');
                    const val = input.value.trim();
                    if(val.length < 2) { alert("Name too short."); return; }
                    State.username = val;
                    UI.updateUsername(val);
                    Storage.save();
                    document.getElementById('overlay-username').style.display = 'none';
                    UI.showToast(`WELCOME, ${val.toUpperCase()}`);
                },
                checkIntegrityOnLoad() {
                    if(State.session.active) {
                        State.session.active = false;
                        State.streak = 0; 
                        Logic.Economy.spend(200, "SYSTEM FAILURE");
                        State.systemIntegrity = Math.max(0, State.systemIntegrity - 15);
                        State.logs.unshift({ date: Date.now(), chapter: "SYSTEM", duration: 0, quality: 0, integrity: 0, note: "CRITICAL FAILURE: GHOST EXIT DETECTED", grade: "F" });
                        alert("CRITICAL FAILURE DETECTED.\nSession terminated abnormally.\nPenalty: -200 XP\nStreak: RESET");
                    }
                    Storage.save();
                },
                factoryReset() { if(confirm("System Purge?")) Storage.reset(); },
                exportData() {
                    const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(State));
                    const dlAnchorElem = document.createElement('a');
                    dlAnchorElem.setAttribute("href", dataStr);
                    dlAnchorElem.setAttribute("download", `ranklock_backup_${new Date().toISOString().slice(0,10)}.json`);
                    document.body.appendChild(dlAnchorElem);
                    dlAnchorElem.click();
                    dlAnchorElem.remove();
                },
                importData(input) {
                    const file = input.files[0];
                    if(!file) return;
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        try {
                            const data = JSON.parse(e.target.result);
                            if(data.rank !== undefined) {
                                State = data;
                                Storage.save();
                                alert("System Restoration Successful.");
                                location.reload();
                            } else { alert("Corrupt Data Signature."); }
                        } catch(err) { alert("Parse Error."); }
                    };
                    reader.readAsText(file);
                }
            },
            
            // --- NEW: ECONOMY LOGIC ---
            Economy: {
                earn(amount, reason) {
                    if(amount <= 0) return;
                    
                    // Check for Active Debt (Global Tax)
                    const totalDebt = Logic.Debt.getTotalMinutes();
                    let multiplier = 1.0;
                    
                    if(totalDebt > 0 && State.session.mode !== 'debt') {
                         multiplier = 0.5;
                         UI.showToast("ACTIVE DEBT TAX APPLIED (50%)");
                    }
                    
                    // Daily Cap Logic
                    let actualEarn = amount * multiplier;
                    
                    if(State.dailyXP >= CONSTANTS.DAILY_XP_CAP) {
                        actualEarn = actualEarn * 0.1; // 90% Tax
                        UI.showToast("DAILY CAP REACHED. 90% TAX.");
                    }
                    
                    State.dailyXP += actualEarn;
                    State.rank += Math.floor(actualEarn);
                    UI.renderStats();
                    Storage.save();
                },
                spend(amount, reason) {
                    if(State.rank >= amount) {
                        State.rank -= amount;
                        UI.renderStats();
                        Storage.save();
                        return true;
                    }
                    return false;
                },
                buy(item) {
                    if(item === 'freeze') {
                        if(this.spend(1000, "Streak Freeze")) {
                             alert("STREAK FROZEN FOR 24 HOURS.");
                             // Logic for streak freeze implementation would go here (timestamp)
                        } else alert("INSUFFICIENT FUNDS");
                    } else if (item === 'repair') {
                        if(State.systemIntegrity >= 100) { alert("Integrity Maximum."); return; }
                        if(this.spend(500, "System Repair")) {
                             State.systemIntegrity = Math.min(100, State.systemIntegrity + 20);
                             UI.showToast("INTEGRITY REPAIRED");
                             UI.renderStats();
                        } else alert("INSUFFICIENT FUNDS");
                    }
                }
            },
            
            // --- NEW: DEBT LOGIC (TIME BASED) ---
            Debt: {
                add(subId, chapter, minutes) {
                    if(minutes <= 0) return;
                    const key = `${subId}|${chapter}`;
                    if(!State.chapterStats[key]) State.chapterStats[key] = {xp:0, debtMinutes: 0};
                    if(!State.chapterStats[key].debtMinutes) State.chapterStats[key].debtMinutes = 0;
                    
                    State.chapterStats[key].debtMinutes += minutes;
                    Storage.save();
                    UI.renderDebts();
                },
                repay(subId, chapter, minutes) {
                    const key = `${subId}|${chapter}`;
                    if(State.chapterStats[key] && State.chapterStats[key].debtMinutes > 0) {
                        State.chapterStats[key].debtMinutes = Math.max(0, State.chapterStats[key].debtMinutes - minutes);
                        Storage.save();
                        UI.renderDebts();
                        UI.showToast(`DEBT REPAID: ${minutes} MINS`, "success");
                    }
                },
                getTotalMinutes() {
                    let total = 0;
                    if(!State.chapterStats) return 0;
                    Object.values(State.chapterStats).forEach(s => {
                        if(s.debtMinutes) total += s.debtMinutes;
                        // Legacy support (count based)
                        if(s.debt) total += (s.debt * 20); 
                    });
                    return total;
                }
            },

            Onboarding: {
                tempData: { exams: [] },
                start() { document.getElementById('overlay-onboarding').style.display = 'flex'; this.showStep(0); },
                showStep(n) { document.querySelectorAll('#overlay-onboarding .tut-slide').forEach(s => s.classList.remove('active')); document.getElementById('onboard-step-'+n).classList.add('active'); },
                next(n) { if(n === 3) this.renderDateInputs(); this.showStep(n); },
                validateExam() {
                    const checks = document.querySelectorAll('#onboard-step-1 .checkbox-custom:checked');
                    const primary = document.querySelector('input[name="primary_exam"]:checked');
                    if(checks.length === 0) { alert("PROTOCOL HALTED: Select at least one exam target."); return; }
                    if(!primary) { alert("PROTOCOL HALTED: Mark one exam as Primary."); return; }
                    
                    let validPrimary = false;
                    checks.forEach(c => { if(c.value === primary.value) validPrimary = true; });
                    if(!validPrimary) { alert("Logic Error: Primary exam must be one of your selected targets."); return; }
                    
                    this.tempData.exams = [];
                    checks.forEach(c => {
                        this.tempData.exams.push({ id: c.value, name: c.value, primary: c.value === primary.value, date: null });
                    });
                    this.next(2);
                },
                renderDateInputs() {
                    const c = document.getElementById('onboard-date-container');
                    c.innerHTML = '';
                    this.tempData.exams.forEach(ex => {
                        const row = document.createElement('div');
                        row.style.marginBottom = '15px';
                        row.innerHTML = `
                            <div style="font-size:0.8rem; font-weight:700; color:var(--text-secondary); margin-bottom:5px;">${ex.name} ${ex.primary ? '<span style="color:var(--accent-lock)">(PRIMARY)</span>' : ''}</div>
                            <input type="date" class="exam-date-input" data-exam="${ex.name}" style="background:var(--bg-elevated);">
                        `;
                        c.appendChild(row);
                    });
                },
                addCustomResource(input) {
                    const val = input.value.trim();
                    if(val) {
                        const cont = document.getElementById('resource-tags-container');
                        const tag = document.createElement('span'); tag.className = 'resource-tag selected'; tag.textContent = val;
                        tag.onclick = function(){ this.classList.toggle('selected'); };
                        cont.appendChild(tag);
                        input.value = '';
                    }
                },
                addCustomEvent() {
                     const name = document.getElementById('new-event-name').value.trim();
                     const date = document.getElementById('new-event-date').value;
                     if(name && date) {
                         if(!State.userProfile.exams) State.userProfile.exams = [];
                         State.userProfile.exams.push({id: 'custom-'+Date.now(), name: name, primary: false, date: date});
                         Storage.save();
                         UI.renderUrgency(); 
                         document.getElementById('new-event-name').value = '';
                         document.getElementById('new-event-date').value = '';
                         UI.showToast("EVENT ADDED");
                     }
                },
                deleteEvent(id) {
                    if(confirm("Delete this event?")) {
                        State.userProfile.exams = State.userProfile.exams.filter(e => e.id !== id);
                        Storage.save();
                        UI.renderUrgency();
                    }
                },
                finish() {
                    const dateInputs = document.querySelectorAll('.exam-date-input');
                    dateInputs.forEach(inp => {
                        const name = inp.dataset.exam;
                        const val = inp.value;
                        const ex = this.tempData.exams.find(e => e.name === name);
                        if(ex && val) ex.date = val;
                    });
                    const resTags = document.querySelectorAll('.resource-tag.selected');
                    const resources = Array.from(resTags).map(t => t.textContent);
                    if(resources.length === 0) resources.push("Notes", "Books"); 
                    
                    let newSubjects = [];
                    const hasJEE = this.tempData.exams.some(e => e.name.includes("JEE") || e.name.includes("Boards"));
                    const hasNEET = this.tempData.exams.some(e => e.name === "NEET");
                    
                    newSubjects.push(CONSTANTS.PRESETS.PHYSICS);
                    newSubjects.push(CONSTANTS.PRESETS.CHEMISTRY);
                    if(hasJEE && !hasNEET) newSubjects.push(CONSTANTS.PRESETS.MATH);
                    else if (hasNEET && !hasJEE) newSubjects.push(CONSTANTS.PRESETS.BIOLOGY);
                    else if (hasJEE && hasNEET) { newSubjects.push(CONSTANTS.PRESETS.MATH); newSubjects.push(CONSTANTS.PRESETS.BIOLOGY); }
                    else newSubjects.push(CONSTANTS.PRESETS.MATH);
                    
                    State.userProfile.exams = this.tempData.exams;
                    State.userProfile.resources = resources;
                    State.subjects = newSubjects;
                    State.onboardingComplete = true;
                    Storage.save();
                    
                    document.getElementById('overlay-onboarding').style.display = 'none';
                    UI.renderMap();
                    UI.renderUrgency(); 
                    Logic.System.showNameModal();
                }
            },
            
            Tutorial: {
                start() { document.getElementById('overlay-tutorial').style.display = 'flex'; },
                restart() { UI.closeOverlays(); document.querySelectorAll('.tut-slide').forEach(s => s.classList.remove('active')); document.getElementById('tut-step-1').classList.add('active'); document.getElementById('overlay-tutorial').style.display = 'flex'; },
                next(step) { document.querySelectorAll('.tut-slide').forEach(s => s.classList.remove('active')); document.getElementById('tut-step-'+step).classList.add('active'); },
                finish() { State.tutorialComplete = true; Storage.save(); document.getElementById('overlay-tutorial').style.display = 'none'; Logic.Onboarding.start(); }
            },
            Session: {
                preFlight(subId, ch, mode, durMins, goalText) {
                    if(!goalState.type) { alert("PROTOCOL ERROR: Select Mission Type."); return; }
                    if(!goalState.resource) { alert("PROTOCOL ERROR: Select Resource."); return; }
                    
                    // DEBT CHECK
                    if(mode === 'debt') {
                        const key = `${subId}|${ch}`;
                        const stats = State.chapterStats[key];
                        const dVal = stats ? (stats.debtMinutes || (stats.debt*20) || 0) : 0;
                        if(dVal <= 0) {
                            alert("NO ACTIVE DEBT ON THIS CHAPTER.");
                            return;
                        }
                    }

                    UI.closeOverlays();
                    if(mode === 'hard') Logic.System.toggleFullscreen();

                    const overlay = document.getElementById('countdown-overlay');
                    const valEl = document.getElementById('countdown-val');
                    overlay.style.display = 'flex';
                    let count = 3;
                    valEl.textContent = count;
                    const int = setInterval(() => {
                        count--;
                        if(count > 0) valEl.textContent = count;
                        else {
                            clearInterval(int);
                            overlay.style.display = 'none';
                            this.start(subId, ch, mode, durMins, goalText);
                        }
                    }, 1000);
                },
                start(subId, ch, mode, durMins, goal) {
                    State.session = { active: true, paused: false, mode: mode, subjectId: subId, chapter: ch, total: durMins*60, remaining: durMins*60, integrity: 100, startTime: Date.now(), goal: goal, pauses: 0, lastPauseTime: 0, pingMissed: 0 };
                    if (mode === 'hard') document.body.classList.add('mode-hard-focus');
                    UI.switchMobileTab('ops');
                    UI.updateSessionView(); Storage.save();
                    
                    if(durMins >= 25) {
                        this.schedulePing(durMins);
                    }
                },
                tick() {
                    if (!State.session.active) return;
                    if (State.session.paused) {
                        if(Date.now() - State.session.lastPauseTime > 120000) {
                            if(State.session.remaining % 5 === 0) {
                                State.session.integrity = Math.max(0, State.session.integrity - 1);
                                UI.updateSessionView();
                            }
                        }
                        return;
                    }
                    State.session.remaining--;
                    if (State.session.remaining <= 0) this.finish();
                    UI.updateTimer();
                },
                
                // --- INTEGRITY PING LOGIC ---
                schedulePing(durationMins) {
                    const safeZone = 5 * 60; 
                    const sessionDuration = durationMins * 60;
                    const randomDelay = Math.floor(Math.random() * (sessionDuration - 2 * safeZone) + safeZone);
                    
                    if(pingTimer) clearTimeout(pingTimer);
                    pingTimer = setTimeout(() => {
                        if(State.session.active && !State.session.paused) {
                            this.triggerPing();
                        }
                    }, randomDelay * 1000);
                },
                triggerPing() {
                    const box = document.getElementById('integrity-ping-box');
                    const container = document.querySelector('.focus-container');
                    if(!box || !container) return;
                    
                    const maxX = container.clientWidth - 80;
                    const maxY = container.clientHeight - 80;
                    const randomX = Math.floor(Math.random() * maxX);
                    const randomY = Math.floor(Math.random() * maxY);
                    
                    box.style.left = randomX + 'px';
                    box.style.top = randomY + 'px';
                    box.style.display = 'block';
                    
                    this.pingWindow = setTimeout(() => {
                        this.handlePingFail();
                    }, 5000);
                },
                handlePingSuccess() {
                    const box = document.getElementById('integrity-ping-box');
                    box.style.display = 'none';
                    if(this.pingWindow) clearTimeout(this.pingWindow);
                    UI.showToast("INTEGRITY CONFIRMED", "success");
                },
                handlePingFail() {
                    const box = document.getElementById('integrity-ping-box');
                    box.style.display = 'none';
                    State.session.pingMissed++;
                    
                    if(State.session.pingMissed === 1) {
                        UI.showToast("WARNING: PRESENCE CHECK MISSED");
                    } else if (State.session.pingMissed === 2) {
                        this.breach("MISSED PING");
                    } else {
                        Logic.Debt.add(State.session.subjectId, State.session.chapter, 15); // Add penalty debt
                        UI.showToast("CRITICAL: 15m DEBT ASSIGNED");
                        this.breach("ABSENCE DETECTED");
                    }
                },

                breach(reason) {
                    if(!State.session.active) return;
                    State.session.integrity = Math.max(0, State.session.integrity - 20);
                    UI.flashRed(State.session.integrity);
                    UI.showToast(`BREACH: ${reason} (-20%)`);
                    UI.updateSessionView(); 
                    if(State.session.integrity < 30) this.abort("CRITICAL SESSION FAILURE (<30%)");
                },
                togglePause() { 
                    if(State.session.mode === 'hard') return; 
                    State.session.paused = !State.session.paused; 
                    if(State.session.paused) { State.session.pauses++; State.session.lastPauseTime = Date.now(); }
                    UI.updateSessionView(); 
                },
                abort(reason) { 
                    const r = reason || "MANUAL ABORT";
                    const timeSpent = State.session.total - State.session.remaining;
                    const timeLeft = Math.ceil(State.session.remaining / 60);
                    
                    State.session.active = false; 
                    if(pingTimer) clearTimeout(pingTimer);
                    document.body.classList.remove('mode-hard-focus'); 
                    
                    // DEBT CREATION ON ABORT
                    if(timeLeft > 5) {
                        Logic.Debt.add(State.session.subjectId, State.session.chapter, timeLeft);
                        alert(`SESSION ABORTED. ${timeLeft} MINS ADDED TO ACTIVE DEBT.`);
                    }

                    State.systemIntegrity = Math.max(0, State.systemIntegrity - 5);
                    State.logs.unshift({ date: Date.now(), chapter: "SYSTEM ABORT", duration: timeSpent, quality: 0, integrity: 0, note: r, grade: "F", pauses: 0 });
                    UI.renderAll(); Storage.save(); 
                },
                finish() { 
                    State.session.active = false; 
                    if(pingTimer) clearTimeout(pingTimer);
                    document.body.classList.remove('mode-hard-focus'); 
                    UI.openAutopsy(); 
                },
                calculateGrade() {
                    const i = State.session.integrity;
                    const p = State.session.pauses;
                    let score = i;
                    score -= (p * 5);
                    if(State.session.mode === 'hard') score += 5;
                    if(score >= 95) return 'S';
                    if(score >= 85) return 'A';
                    if(score >= 70) return 'B';
                    if(score >= 50) return 'C';
                    return 'F';
                }
            },
            Rank: {
                getData(p) { for(let i=CONSTANTS.RANKS.length-1; i>=0; i--) if(p >= CONSTANTS.RANKS[i].t) return CONSTANTS.RANKS[i]; return CONSTANTS.RANKS[0]; }
            },
            Chapter: {
                get(s,c) { const k=`${s}|${c}`; if(!State.chapterStats[k]) State.chapterStats[k]={xp:0,debtMinutes:0}; return State.chapterStats[k]; },
                addXP(s,c,a) { this.get(s,c).xp += a; },
            },
            UI: {
                addSubject: () => {
                    const v = document.getElementById('new-subject-input').value.trim();
                    if(v) { State.subjects.push({id: v.toLowerCase(), name: v, chapters:['Intro']}); UI.renderMap(); UI.populateManagerSelect(); Storage.save(); document.getElementById('new-subject-input').value=''; }
                },
                addChapter: () => {
                    const sId = document.getElementById('manager-subject-select').value;
                    const v = document.getElementById('new-chapter-input').value.trim();
                    const s = State.subjects.find(x=>x.id===sId);
                    if(s && v) { s.chapters.push(v); UI.renderMap(); Storage.save(); document.getElementById('new-chapter-input').value=''; }
                },
                selectMode: (m) => {
                    if(m === 'hard' && State.rank < CONSTANTS.HARD_MODE_REQ) return; 
                    UI.setWizardMode(m);
                },
                selectDuration: (d) => {
                    if(d === 'custom') {
                        document.querySelectorAll('[data-dur]').forEach(b => b.classList.remove('selected'));
                        document.getElementById('custom-time-input').classList.add('active');
                        const val = document.getElementById('custom-time-input').value;
                        if(val && val >= 1 && val <= 600) UI.setWizardDur(parseInt(val));
                    } else {
                         document.getElementById('custom-time-input').classList.remove('active');
                         document.getElementById('custom-time-input').value = '';
                         UI.setWizardDur(d);
                    }
                },
                setGoalType(el, type) {
                    document.getElementById('goal-type-grid').querySelectorAll('.goal-chip').forEach(c => c.classList.remove('selected'));
                    el.classList.add('selected');
                    goalState.type = type;
                    Logic.UI.updateGoalDisplay();
                },
                setGoalRes(el, res) {
                    document.getElementById('goal-resource-grid').querySelectorAll('.goal-chip').forEach(c => c.classList.remove('selected'));
                    el.classList.add('selected');
                    goalState.resource = res;
                    Logic.UI.updateGoalDisplay();
                },
                updateGoalDisplay() {
                    const disp = document.getElementById('generated-goal-text');
                    const scope = document.getElementById('goal-scope-input').value.trim();
                    if(!goalState.type || !goalState.resource) {
                        disp.textContent = "SELECT PROTOCOL DATA";
                        disp.style.color = "var(--text-muted)";
                    } else {
                        const final = `${goalState.type} : ${goalState.resource} ${scope ? ' : '+scope : ''}`;
                        disp.textContent = final;
                        disp.style.color = "var(--accent-lock)";
                    }
                }
            }
        };

        const UI = {
            wizard: { subject: null, chapter: null, mode: 'normal', duration: 25 },
            autopsy: { mistake: false, calculatedGrade: 'C' },

            init() {
                const btnInit = document.getElementById('btn-init-session');
                if(btnInit) btnInit.onclick = () => { this.resetWizard(); this.openOverlay('overlay-setup'); this.wizardStep('subject'); };
                
                const btnLaunch = document.getElementById('btn-setup-launch');
                if(btnLaunch) btnLaunch.onclick = () => {
                    const disp = document.getElementById('generated-goal-text').textContent;
                    if(disp.includes("SELECT PROTOCOL")) { alert("Protocol Incomplete."); return; }
                    Logic.Session.preFlight(this.wizard.subject, this.wizard.chapter, this.wizard.mode, this.wizard.duration, disp);
                };
                
                const btnPause = document.getElementById('btn-pause-session');
                if(btnPause) btnPause.onclick = () => Logic.Session.togglePause();
                
                const btnAbort = document.getElementById('btn-emergency-exit');
                if(btnAbort) btnAbort.onclick = () => { if(confirm("Abort?")) Logic.Session.abort(); };
                
                const btnAutopsySubmit = document.getElementById('btn-autopsy-submit');
                if(btnAutopsySubmit) btnAutopsySubmit.onclick = this.submitAutopsy.bind(this);
                
                document.querySelectorAll('.overlay').forEach(ov => {
                    ov.addEventListener('click', (e) => { 
                        if(e.target === ov && ov.id !== 'overlay-tutorial' && ov.id !== 'overlay-username' && ov.id !== 'overlay-autopsy' && ov.id !== 'overlay-onboarding' && !State.session.active) this.closeOverlays(); 
                    });
                });
            },

            updateUsername(name) {
                document.querySelectorAll('.user-name-target').forEach(el => el.textContent = name);
                document.title = `RANKLOCK DISCIPLINE | ${name.toUpperCase()}`;
                const commsName = document.getElementById('comms-name');
                if(commsName) commsName.value = name;
            },

            toggleSidebar() { document.getElementById('main-layout').classList.toggle('sidebar-collapsed'); },
            
            switchMobileTab(tab) {
                document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
                const tabs = document.querySelectorAll('.nav-tab');
                if(tab === 'ops') tabs[0].classList.add('active');
                if(tab === 'intel') tabs[1].classList.add('active');
                if(tab === 'map') tabs[2].classList.add('active');
                
                const sidebar = document.getElementById('sidebar');
                const stage = document.getElementById('stage');
                if (tab === 'ops') { stage.classList.add('mobile-tab-active'); sidebar.classList.remove('mobile-tab-active'); this.closeOverlays(); } 
                else if (tab === 'intel') { sidebar.classList.add('mobile-tab-active'); stage.classList.remove('mobile-tab-active'); this.closeOverlays(); } 
                else if (tab === 'map') { this.openMap(); }
                if(tab === 'events') tabs[3].classList.add('active');
            },

            renderAll() { this.renderStats(); this.renderMap(); this.renderDebts(); this.renderLogs(); this.populateManagerSelect(); this.updateSessionView(); },
            
            renderUrgency() {
                const container = document.getElementById('events-container');
                if(!container) return;
                container.innerHTML = '';
                
                let exams = State.userProfile.exams || [];
                exams.sort((a,b) => {
                    if(!a.date) return 1;
                    if(!b.date) return -1;
                    return new Date(a.date) - new Date(b.date);
                });
                
                exams.forEach(ex => {
                    const card = document.createElement('div');
                    card.className = 'card';
                    card.style.marginBottom = '12px';
                    
                    let days = 'Unknown';
                    let urgencyClass = '';
                    let urgencyText = 'NO DATE';
                    
                    if(ex.date) {
                        const d1 = new Date();
                        const d2 = new Date(ex.date);
                        const diff = Math.ceil((d2 - d1) / (1000 * 60 * 60 * 24));
                        days = diff;
                        
                        if(diff < 30) { urgencyClass = 'urgency-crit'; urgencyText = 'CRITICAL'; }
                        else if(diff < 90) { urgencyClass = 'urgency-high'; urgencyText = 'HIGH'; }
                        else { urgencyClass = 'urgency-med'; urgencyText = 'NORMAL'; }
                    }
                    
                    if(urgencyClass) card.classList.add(urgencyClass);
                    
                    const linkData = CONSTANTS.LINKS[ex.name] || CONSTANTS.LINKS["Other"];
                    const mainLink = linkData.main;
                    
                    const isCustom = ex.id && ex.id.startsWith('custom-');
                    const actions = isCustom ? 
                        `<button class="btn btn-outline" style="padding:4px 8px; font-size:0.6rem;" onclick="Logic.Onboarding.deleteEvent('${ex.id}')">DELETE</button>` : '';

                    card.innerHTML = `
                        <div style="display:flex; justify-content:space-between; align-items:flex-start;">
                            <div>
                                <div style="font-weight:800; font-size:1.1rem; color:var(--text-primary);">${ex.name} ${ex.primary ? '‚≠ê' : ''}</div>
                                <div style="font-size:0.75rem; color:var(--text-muted);">${ex.date ? new Date(ex.date).toLocaleDateString() : 'Date Not Set'}</div>
                            </div>
                            <div style="text-align:right;">
                                <div style="font-size:1.5rem; font-weight:900; color:var(--text-primary); line-height:1;">${days}</div>
                                <div style="font-size:0.6rem; font-weight:700; color:var(--text-secondary);">DAYS LEFT</div>
                            </div>
                        </div>
                        <div style="margin-top:10px; font-size:0.7rem; font-weight:700; color:var(--text-secondary); display:flex; justify-content:space-between; align-items:center;">
                            <span>URGENCY: ${urgencyText}</span>
                            ${actions}
                        </div>
                        <div style="margin-top:12px; padding-top:10px; border-top:1px solid var(--border-ui); display:flex; gap:10px;">
                            <a href="${mainLink}" target="_blank" class="btn btn-outline" style="flex:1; padding:8px; font-size:0.7rem; text-decoration:none;">VERIFY INTEL ‚Üó</a>
                        </div>
                        <div style="font-size:0.6rem; color:var(--text-muted); margin-top:8px; font-style:italic;">Disclaimer: Dates subject to change. Verify on official site.</div>
                    `;
                    container.appendChild(card);
                });

                const primary = exams.find(e => e.primary);
                const summaryText = document.getElementById('map-summary-text');
                if(primary && primary.date && summaryText) {
                    const d1 = new Date();
                    const d2 = new Date(primary.date);
                    const days = Math.ceil((d2 - d1) / (1000 * 60 * 60 * 24));
                    if(days > 0) summaryText.innerHTML = `<span style="color:var(--accent-crit); font-weight:700;">‚ö† ${primary.name}: ${days} DAYS LEFT</span>`;
                }
            },

            renderStats() {
                const rankData = Logic.Rank.getData(State.rank);
                const displayRank = document.getElementById('display-rank');
                const displayRankTitle = document.getElementById('display-rank-title');
                const perkBadge = document.getElementById('rank-perk-badge');
                
                if(displayRank) displayRank.textContent = State.rank;
                if(displayRankTitle) displayRankTitle.textContent = rankData.title;
                
                // Show wallet in header
                document.getElementById('stat-xp').textContent = State.rank;

                let next = 100;
                for(let r of CONSTANTS.RANKS) { if(r.t > State.rank){ next = r.t; perkBadge.textContent = `NEXT: ${r.perk.toUpperCase()}`; break; } }
                if(State.rank >= 100000) perkBadge.textContent = "AUTHORITY ABSOLUTE";

                const prev = CONSTANTS.RANKS.find(r => r.t <= State.rank).t; 
                // Fix for rank bar calculation
                const prevRank = CONSTANTS.RANKS.reduce((acc, curr) => (curr.t <= State.rank ? curr : acc), CONSTANTS.RANKS[0]);
                const nextRank = CONSTANTS.RANKS.find(r => r.t > State.rank) || {t: 200000}; // Arbitrary max
                const perc = ((State.rank - prevRank.t) / (nextRank.t - prevRank.t)) * 100;
                
                const rankBarFill = document.getElementById('rank-bar-fill');
                const rankNextVal = document.getElementById('rank-next-val');
                if(rankBarFill) rankBarFill.style.width = `${Math.min(100,perc)}%`;
                if(rankNextVal) rankNextVal.textContent = `NEXT: ${nextRank.t}`;
                
                const h = Math.floor(State.dailySeconds/3600), m = Math.floor((State.dailySeconds%3600)/60);
                const dailyQualEl = document.getElementById('stat-daily-quality');
                if(dailyQualEl) dailyQualEl.textContent = `${h}h ${m}m Focus`;
                
                const intEl = document.getElementById('stat-global-integrity');
                if(intEl) {
                     intEl.textContent = `${Math.floor(State.systemIntegrity)}%`;
                     intEl.className = `stat-value tabular ${State.systemIntegrity > 80 ? 'integrity-ok' : (State.systemIntegrity > 50 ? 'integrity-warn' : 'integrity-crit')}`;
                }
                
                const summaryText = document.getElementById('map-summary-text');
                if(summaryText && !summaryText.innerHTML.includes('DAYS LEFT')) {
                    const totalCh = State.subjects.reduce((a,b)=>a+b.chapters.length, 0);
                    summaryText.textContent = `${State.subjects.length} Subjects | ${totalCh} Chapters`;
                }
            },

            renderMap() {
                const c = document.getElementById('map-accordion-container');
                if(!c) return;
                c.innerHTML = '';
                State.subjects.forEach(s => {
                    const g = document.createElement('div'); g.className = 'subject-group';
                    const h = document.createElement('div'); h.className = 'subject-header';
                    h.innerHTML = `<span>${s.name}</span> <span style="font-size:0.7rem; color:var(--text-muted)">${s.chapters.length}</span>`;
                    h.onclick = () => g.classList.toggle('expanded');
                    
                    const chList = document.createElement('div'); chList.className = 'subject-chapters';
                    s.chapters.forEach(ch => {
                        const stats = Logic.Chapter.get(s.id, ch);
                        // Debt is now Minutes. Convert for legacy check or direct check
                        const debtMins = stats.debtMinutes || (stats.debt*20) || 0;
                        
                        const row = document.createElement('div'); row.className = 'chapter-item';
                        if(debtMins>0) row.classList.add('has-debt');
                        let badges = [];
                        if(debtMins>0) badges.push(`<span style="color:var(--accent-crit); font-weight:700;">DEBT:${debtMins}m</span>`);
                        if(stats.xp>0) badges.push(`<span style="color:var(--accent-succ);">XP:${stats.xp}</span>`);
                        row.innerHTML = `<span style="font-size:0.85rem;">${ch}</span> <div style="font-size:0.7rem;">${badges.join(' ')}</div>`;
                        row.onclick = () => {
                            // Quick start logic handles Debt Clearance mode selection in wizard
                            this.quickStart(s.id, s.name, ch);
                        };
                        chList.appendChild(row);
                    });
                    g.appendChild(h); g.appendChild(chList); c.appendChild(g);
                });
            },

            renderDebts() {
                const list = document.getElementById('debt-list'); 
                if(!list) return;
                list.innerHTML = '';
                let totalMins = 0;
                if(!State.chapterStats) State.chapterStats = {};
                
                Object.keys(State.chapterStats).forEach(k => {
                    const s = State.chapterStats[k];
                    // Unify debt model (legacy count * 20 + new minutes)
                    const dMin = (s.debtMinutes || 0) + ((s.debt || 0) * 20);
                    
                    if(dMin > 0) {
                        const parts = k.split('|');
                        const sid = parts[0];
                        const ch = parts[1] || 'Unknown';
                        const sObj = State.subjects.find(sub=>sub.id===sid);
                        const sName = sObj ? sObj.name.substr(0,3) : sid;
                        
                        totalMins += dMin;
                        const d = document.createElement('div'); 
                        d.className = 'log-item';
                        d.style.borderLeftColor = 'var(--accent-crit)';
                        d.innerHTML = `<div style="display:flex; justify-content:space-between; font-weight:700;"><span>${ch}</span><span style="color:var(--accent-crit)">${dMin}m</span></div><div style="font-size:0.65rem; color:var(--text-muted);">${sName.toUpperCase()}</div>`;
                        list.appendChild(d);
                    }
                });
                const debtCountEl = document.getElementById('debt-count');
                if(debtCountEl) debtCountEl.textContent = `${totalMins}m`;
                if(totalMins === 0) list.innerHTML = '<div style="color:var(--text-muted); padding:10px; font-size:0.75rem; text-align:center;">System Clear. No Debts.</div>';
            },

            renderLogs() {
                const c = document.getElementById('recent-logs-container'); 
                if(!c) return;
                c.innerHTML = '';
                State.logs.slice(0, 10).forEach((l, idx) => {
                    const d = document.createElement('div'); d.className = 'log-item';
                    let color = 'var(--text-muted)';
                    if(l.grade === 'S') color = 'var(--accent-gold)';
                    if(l.grade === 'A') color = 'var(--accent-succ)';
                    if(l.grade === 'F') color = 'var(--accent-crit)';
                    const mins = Math.floor(l.duration / 60);
                    const secs = l.duration % 60;
                    d.style.borderLeftColor = color;
                    d.innerHTML = `<div style="display:flex; justify-content:space-between; font-weight:700;"><span>${l.chapter}</span><span style="color:${color}">${l.grade || '-'}</span></div><div style="font-size:0.65rem; color:var(--text-muted);">${new Date(l.date).toLocaleDateString()} ‚Ä¢ ${mins}m ${secs}s</div>`;
                    d.onclick = () => this.showLogDetails(idx);
                    c.appendChild(d);
                });
            },
            
            showLogDetails(idx) {
                const log = State.logs[idx];
                const content = document.getElementById('log-details-content');
                if(!log || !content) return;
                let gradeClass = `grade-${log.grade}`;
                const mins = Math.floor(log.duration/60);
                const secs = log.duration % 60;
                content.innerHTML = `
                    <div style="text-align:center; padding: 20px 0; border-bottom: 1px solid var(--border-ui);">
                        <div style="font-size:0.8rem; color:var(--text-secondary); margin-bottom: 5px;">SYSTEM EVALUATION</div>
                        <div class="grade-badge ${gradeClass}" style="font-size:4rem;">${log.grade || 'N/A'}</div>
                        <div style="margin-top:10px; font-weight:700; color:var(--text-primary);">${log.chapter}</div>
                    </div>
                    <div style="padding: 20px 0; display:grid; grid-template-columns: 1fr 1fr; gap:10px; border-bottom: 1px solid var(--border-ui);">
                        <div class="stat-item"><span class="stat-label">DURATION</span><span class="stat-value">${mins}m ${secs}s</span></div>
                        <div class="stat-item"><span class="stat-label">INTEGRITY</span><span class="stat-value ${log.integrity<50?'integrity-crit':'integrity-ok'}">${log.integrity}%</span></div>
                        <div class="stat-item"><span class="stat-label">PAUSES</span><span class="stat-value">${log.pauses || 0}</span></div>
                        <div class="stat-item"><span class="stat-label">DATE</span><span class="stat-value">${new Date(log.date).toLocaleDateString()}</span></div>
                    </div>
                    <div style="padding: 20px 0;">
                        <div style="font-size:0.7rem; color:var(--text-muted); font-weight:700; margin-bottom:10px;">KNOWLEDGE CRYSTALLIZATION</div>
                        <div style="background:var(--bg-elevated); padding:15px; border-radius:var(--radius-sm); font-size:0.9rem; line-height:1.5;">${log.note || 'No data recorded.'}</div>
                    </div>
                `;
                this.openOverlay('overlay-log-details');
            },

            quickStart(subId, subName, chapter) {
                this.wizard.subject = subId;
                this.wizard.chapter = chapter;
                const targetDisplay = document.getElementById('wizard-target-display');
                if(targetDisplay) targetDisplay.textContent = `${subName} - ${chapter}`;
                
                // Show Debt Mode option if applicable
                const key = `${subId}|${chapter}`;
                const stats = State.chapterStats[key];
                const debtMins = stats ? ((stats.debtMinutes||0) + ((stats.debt||0)*20)) : 0;
                
                const debtBtn = document.getElementById('btn-mode-debt');
                if(debtMins > 0) {
                    debtBtn.classList.remove('hidden');
                    debtBtn.querySelector('.choice-meta').textContent = `REPAY ${debtMins} MINS`;
                } else {
                    debtBtn.classList.add('hidden');
                }
                
                this.openOverlay('overlay-setup');
                this.wizardStep('mode');
            },

            resetWizard() { 
                this.wizard = { subject: null, chapter: null, mode: 'normal', duration: 25 }; 
                goalState = { type: null, resource: null };
                document.querySelectorAll('.goal-chip').forEach(c => c.classList.remove('selected'));
                document.getElementById('goal-scope-input').value = '';
                document.getElementById('generated-goal-text').textContent = 'SELECT PROTOCOL';
                document.getElementById('generated-goal-text').style.color = 'var(--text-muted)';
                this.renderWizardSubjects(); 
                
                const resGrid = document.getElementById('goal-resource-grid');
                resGrid.innerHTML = '';
                let resources = State.userProfile.resources || ["Notes", "NCERT", "PYQs"];
                if(resources.length === 0) resources = ["Notes", "NCERT", "PYQs"];
                
                resources.forEach(r => {
                    const d = document.createElement('div');
                    d.className = 'goal-chip';
                    d.textContent = r.toUpperCase();
                    d.onclick = function() { Logic.UI.setGoalRes(this, r.toUpperCase()); };
                    resGrid.appendChild(d);
                });
            },
            
            openOverlay(id) { 
                document.querySelectorAll('.overlay').forEach(o => o.style.display='none'); 
                const ov = document.getElementById(id);
                if(ov) ov.style.display = 'flex'; 
                
                if(id === 'overlay-setup') {
                    const hardBtn = document.getElementById('btn-mode-hard');
                    const hardMeta = document.getElementById('hard-mode-meta');
                    if(State.rank < CONSTANTS.HARD_MODE_REQ) {
                        hardBtn.classList.add('locked');
                        hardMeta.textContent = `LOCKED. REQ: ${CONSTANTS.HARD_MODE_REQ} XP`;
                    } else {
                        hardBtn.classList.remove('locked');
                        hardMeta.textContent = `No pause. Fullscreen.`;
                    }
                }
                
                if(id === 'overlay-autopsy') {
                    this.autopsy.calculatedGrade = Logic.Session.calculateGrade();
                    document.getElementById('auto-grade-display').textContent = this.autopsy.calculatedGrade;
                    document.getElementById('auto-grade-display').className = `grade-badge grade-${this.autopsy.calculatedGrade}`;
                    document.getElementById('auto-integrity-display').textContent = `${State.session.integrity}%`;
                    const durSecs = State.session.total - State.session.remaining;
                    const durMins = Math.floor(durSecs / 60);
                    const durRemSecs = durSecs % 60;
                    document.getElementById('auto-duration-display').textContent = `${durMins}m ${durRemSecs}s`;
                    const eff = Math.round(State.session.integrity * (1 - (State.session.pauses * 0.05)));
                    document.getElementById('auto-efficiency-display').textContent = `${Math.max(0, eff)}%`;

                    const analysisEl = document.getElementById('auto-analysis-text');
                    let analysis = "ANALYSIS COMPLETE.";
                    const grade = this.autopsy.calculatedGrade;
                    
                    if(grade === 'S') analysis = "FLAWLESS VICTORY. SYSTEM OPTIMAL.";
                    else if(grade === 'A') analysis = "HIGH EFFICIENCY DETECTED.";
                    else if(grade === 'B') analysis = "ACCEPTABLE PARAMETERS.";
                    else if(grade === 'C') analysis = "MEDIOCRE. DISCIPLINE REQUIRED.";
                    else if(grade === 'F') analysis = "SYSTEM FAILURE. REBOOT.";
                    
                    if(State.session.pauses > 2) analysis += " EXCESSIVE PAUSES.";
                    
                    const chStats = Logic.Chapter.get(State.session.subjectId, State.session.chapter);
                    const debtMins = (chStats.debtMinutes||0) + ((chStats.debt||0)*20);
                    const totalDebt = Logic.Debt.getTotalMinutes();
                    
                    if(State.session.mode === 'debt') {
                        analysis += " [DEBT REPAYMENT MODE]";
                        analysisEl.style.color = "var(--accent-lock)";
                    } else if (totalDebt > 0) {
                        analysis += " [ACTIVE DEBT TAX APPLIED]";
                        analysisEl.style.color = "var(--accent-warn)";
                    } else {
                        analysisEl.style.color = "var(--text-secondary)";
                    }
                    analysisEl.textContent = analysis;

                    // XP CALCULATION
                    let qMod = 1.0;
                    if(grade === 'S') qMod = 1.3;
                    if(grade === 'A') qMod = 1.1;
                    if(grade === 'C') qMod = 0.8;
                    if(grade === 'F') qMod = 0.5;
                    const mMod = State.session.mode==='hard' ? 1.5 : 1;
                    
                    let pts = Math.floor((durSecs/60)*10*qMod*mMod);
                    
                    const xpDisplay = document.getElementById('auto-xp-display');
                    
                    if(State.session.mode === 'debt') {
                        // In Debt Mode, XP is negligible, focus is repayment
                        pts = Math.floor(pts * 0.1); 
                        xpDisplay.textContent = `+${pts} (REPAYMENT MODE)`;
                        xpDisplay.style.color = "var(--text-muted)";
                    } else if (totalDebt > 0) {
                        pts = Math.floor(pts * 0.5); // 50% Tax
                        xpDisplay.textContent = `+${pts} (DEBT TAX -50%)`;
                        xpDisplay.style.color = "var(--accent-warn)";
                    } else {
                        xpDisplay.textContent = `+${pts}`;
                        xpDisplay.style.color = "var(--accent-lock)";
                    }
                    document.getElementById('btn-autopsy-submit').disabled = true;
                }
            },
            
            openMarket() {
                document.getElementById('market-balance').textContent = State.rank;
                const list = document.getElementById('market-listings');
                list.innerHTML = `
                    <div class="market-item">
                        <div>
                            <div style="font-weight:700;">STREAK FREEZE</div>
                            <div style="font-size:0.7rem; color:var(--text-muted);">Protect streak for 24h.</div>
                        </div>
                        <button class="btn btn-outline btn-sm" onclick="Logic.Economy.buy('freeze')"><span class="xp-cost">1000 XP</span></button>
                    </div>
                    <div class="market-item">
                        <div>
                            <div style="font-weight:700;">SYSTEM REPAIR</div>
                            <div style="font-size:0.7rem; color:var(--text-muted);">Restore 20% Integrity.</div>
                        </div>
                        <button class="btn btn-outline btn-sm" onclick="Logic.Economy.buy('repair')"><span class="xp-cost">500 XP</span></button>
                    </div>
                `;
                this.openOverlay('overlay-market');
            },
            
            closeOverlays() { document.querySelectorAll('.overlay').forEach(o => o.style.display='none'); },
            openMap() { this.renderMap(); this.openOverlay('overlay-map'); },
            openEvents() { this.renderUrgency(); this.openOverlay('overlay-events'); if(window.innerWidth <= 1024) this.switchMobileTab('events'); },
            openSettings() { this.openOverlay('overlay-settings'); },
            openAutopsy() { this.openOverlay('overlay-autopsy'); },
            openComms() { this.openOverlay('overlay-comms'); },
            commsSuccess() { this.closeOverlays(); this.showToast("DATA TRANSMITTED TO HQ", "success"); },
            
            wizardStep(id) { 
                document.querySelectorAll('.wizard-step').forEach(e => e.classList.remove('active')); 
                const step = document.getElementById('step-'+id);
                if(step) step.classList.add('active'); 
            },
            wizardBack() {
                const active = document.querySelector('.wizard-step.active');
                if(!active) return;
                const stepId = active.id;
                if(stepId === 'step-chapter') this.wizardStep('subject');
                if(stepId === 'step-mode') this.wizardStep('chapter'); 
            },

            renderWizardSubjects() {
                const g = document.getElementById('setup-subject-grid'); 
                if(!g) return;
                g.innerHTML = '';
                State.subjects.forEach(s => {
                    const d = document.createElement('div'); d.className = 'choice-btn';
                    d.innerHTML = `<span class="choice-title">${s.name}</span><span class="choice-meta">${s.chapters.length} Ch</span>`;
                    d.onclick = () => { this.wizard.subject = s.id; this.renderWizardChapters(s); this.wizardStep('chapter'); };
                    g.appendChild(d);
                });
            },

            renderWizardChapters(sub) {
                const g = document.getElementById('setup-chapter-grid'); 
                if(!g) return;
                g.innerHTML = '';
                sub.chapters.forEach(c => {
                    const stats = Logic.Chapter.get(sub.id, c);
                    const debtMins = (stats.debtMinutes||0) + ((stats.debt||0)*20);
                    const d = document.createElement('div'); d.className = 'choice-btn';
                    if(debtMins > 0) d.classList.add('has-debt-warn');
                    d.innerHTML = `<span class="choice-title">${c}</span>`;
                    d.onclick = () => { 
                        this.wizard.chapter = c; 
                        const targetDisplay = document.getElementById('wizard-target-display');
                        if(targetDisplay) targetDisplay.textContent = `${sub.name} - ${c}`; 
                        
                        // Show/Hide Debt mode logic happens in quickStart, but we check here too for direct wizard usage
                        const debtBtn = document.getElementById('btn-mode-debt');
                        if(debtMins > 0) {
                            debtBtn.classList.remove('hidden');
                            debtBtn.querySelector('.choice-meta').textContent = `REPAY ${debtMins} MINS`;
                        } else {
                            debtBtn.classList.add('hidden');
                        }

                        this.wizardStep('mode'); 
                    };
                    g.appendChild(d);
                });
            },

            setWizardMode(m) { this.wizard.mode = m; document.querySelectorAll('[data-mode]').forEach(b => b.classList.toggle('selected', b.dataset.mode === m)); },
            setWizardDur(d) { 
                this.wizard.duration = d; 
                if(typeof d === 'number') {
                    const cust = document.getElementById('custom-time-input');
                    if([25, 50, 90].includes(d)) cust.value = '';
                    document.querySelectorAll('[data-dur]').forEach(b => b.classList.toggle('selected', parseInt(b.dataset.dur) === d)); 
                }
            },
            
            populateManagerSelect() {
                const s = document.getElementById('manager-subject-select'); 
                if(!s) return;
                s.innerHTML = '';
                State.subjects.forEach(sub => { const opt = document.createElement('option'); opt.value = sub.id; opt.textContent = sub.name; s.appendChild(opt); });
            },

            updateSessionView() {
                const metaEl = document.getElementById('active-session-meta');
                const btnInit = document.getElementById('btn-init-session');
                const btnAbort = document.getElementById('btn-emergency-exit');
                const btnPause = document.getElementById('btn-pause-session');
                const overlay = document.getElementById('integrity-visual-overlay');
                const badge = document.getElementById('session-integrity-badge');
                const badgeVal = document.getElementById('session-integrity-val');
                
                if(State.session.active) {
                    const sn = State.subjects.find(s=>s.id===State.session.subjectId)?.name || 'Unknown';
                    const goalHtml = State.session.goal ? `<div class="context-goal">MISSION: ${State.session.goal}</div>` : '';
                    if(metaEl) metaEl.innerHTML = `<div class="context-subject">${sn}</div><div class="context-chapter">${State.session.chapter}</div>${goalHtml}`;
                    if(btnInit) btnInit.classList.add('hidden');
                    if(btnAbort) btnAbort.classList.remove('hidden');
                    if(btnPause) {
                        if(State.session.mode==='normal') { btnPause.classList.remove('hidden'); btnPause.textContent = State.session.paused ? "RESUME" : "PAUSE"; }
                        else btnPause.classList.add('hidden');
                    }
                    if(badge && badgeVal) {
                        badge.classList.add('active');
                        badgeVal.textContent = `${State.session.integrity}%`;
                        badgeVal.style.color = State.session.integrity > 80 ? 'var(--accent-succ)' : 'var(--accent-crit)';
                    }
                    const integ = State.session.integrity;
                    overlay.style.opacity = integ < 50 ? (0.8 - (integ/100)) : 0;
                    if(integ < 40) overlay.style.backgroundColor = `rgba(239, 68, 68, ${0.3 - (integ/200)})`; 
                    this.updateStats(); 
                } else {
                    if(metaEl) metaEl.innerHTML = `<div class="context-subject">SYSTEM IDLE</div><div class="context-chapter">Ready for initialization</div>`;
                    if(btnInit) btnInit.classList.remove('hidden');
                    if(btnAbort) btnAbort.classList.add('hidden');
                    if(btnPause) btnPause.classList.add('hidden');
                    if(overlay) { overlay.style.opacity = 0; overlay.style.backgroundColor = 'transparent'; }
                    if(badge) badge.classList.remove('active');
                    const timerDisp = document.getElementById('timer-display');
                    if(timerDisp) { timerDisp.textContent = "00:00"; timerDisp.style.opacity = 1; }
                }
            },
            
            updateTimer() {
                if(!State.session.active) return;
                const r = State.session.remaining;
                const timerDisp = document.getElementById('timer-display');
                if(timerDisp) {
                    timerDisp.textContent = `${Math.floor(r/60).toString().padStart(2,'0')}:${(r%60).toString().padStart(2,'0')}`;
                    timerDisp.style.opacity = State.session.paused ? 0.3 : 1;
                }
            },

            showToast(msg, type='normal') {
                const t = document.getElementById('integrity-toast');
                if(!t) return;
                t.textContent = msg; 
                t.style.display = 'block';
                if(type === 'success') t.style.background = 'var(--accent-succ)';
                else t.style.background = 'var(--accent-crit)';
                setTimeout(()=> { t.style.display='none'; t.style.background = 'var(--accent-crit)'; }, 3000);
            },

            flashRed(currentIntegrity) {
                const o = document.getElementById('integrity-visual-overlay');
                if(!o) return;
                const severity = 100 - currentIntegrity;
                o.style.opacity = 1;
                o.style.borderWidth = `${10 + (severity/5)}px`; 
                o.style.boxShadow = `inset 0 0 ${50 + severity}px var(--accent-crit)`;
                setTimeout(() => { 
                    o.style.borderWidth = '0px'; 
                    o.style.boxShadow = 'none'; 
                    o.style.opacity = currentIntegrity < 50 ? (0.8 - (currentIntegrity/100)) : 0;
                }, 300);
            },

            toggleMistake(v) { 
                this.autopsy.mistake=v; 
                const btnNo = document.getElementById('autopsy-mistake-no');
                const btnYes = document.getElementById('autopsy-mistake-yes');
                if(btnNo) btnNo.classList.toggle('selected',!v); 
                if(btnYes) btnYes.classList.toggle('selected',v); 
            },

            validateAutopsy() {
                const val = document.getElementById('autopsy-summary').value;
                const btn = document.getElementById('btn-autopsy-submit');
                if(val.length > 10) btn.disabled = false;
                else btn.disabled = true;
            },

            submitAutopsy() {
                const autopsySum = document.getElementById('autopsy-summary');
                const note = autopsySum ? autopsySum.value : '';
                const dur = State.session.total - State.session.remaining;
                const durMins = Math.floor(dur / 60);
                const grade = this.autopsy.calculatedGrade;
                
                let qMod = 1.0;
                if(grade === 'S') qMod = 1.3;
                if(grade === 'A') qMod = 1.1;
                if(grade === 'B') qMod = 1.0;
                if(grade === 'C') qMod = 0.8;
                if(grade === 'F') qMod = 0.5;

                const mMod = State.session.mode==='hard' ? 1.5 : 1;
                let pts = Math.floor((dur/60)*10*qMod*mMod);
                
                // --- DEBT REPAYMENT LOGIC ---
                if(State.session.mode === 'debt' && (grade === 'A' || grade === 'S')) {
                    Logic.Debt.repay(State.session.subjectId, State.session.chapter, durMins);
                    pts = Math.floor(pts * 0.1); // Minimal XP for repayment
                } else {
                    // Normal session logic
                    if(this.autopsy.mistake) {
                        Logic.Debt.add(State.session.subjectId, State.session.chapter, 15); // Penalty debt
                        UI.showToast("MISTAKE RECORDED: 15m DEBT ADDED");
                    }
                    // Apply XP Earnings
                    Logic.Economy.earn(pts, "SESSION COMPLETE");
                }
                
                State.dailySeconds += dur;
                Logic.Chapter.addXP(State.session.subjectId, State.session.chapter, pts);
                
                let repairAmount = 0;
                if(grade === 'S') repairAmount = 5;
                else if(grade === 'A') repairAmount = 3;
                else if(grade === 'B') repairAmount = 1;

                if(repairAmount > 0 && State.systemIntegrity < 100) {
                    State.systemIntegrity = Math.min(100, State.systemIntegrity + repairAmount);
                    setTimeout(() => UI.showToast(`SYSTEM INTEGRITY REPAIRED (+${repairAmount}%)`, 'success'), 1500);
                }
                if(grade === 'F') State.systemIntegrity = Math.max(0, State.systemIntegrity - 5);

                State.logs.unshift({ 
                    date: Date.now(), 
                    chapter: State.session.chapter, 
                    duration: dur, 
                    grade: grade,
                    integrity: State.session.integrity, 
                    pauses: State.session.pauses, 
                    note: note 
                });
                
                if(autopsySum) autopsySum.value='';
                this.closeOverlays(); UI.renderAll(); Storage.save();
            }
        };

        window.addEventListener('DOMContentLoaded', () => { Logic.System.init(); });
    </script>
</body>
</html>

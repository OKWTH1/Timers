<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>JEE 2026 | RANKLOCK</title>
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>‚åõ</text></svg>">
<style>
  @import url('https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;500;700&display=swap');
  @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@300;500&display=swap');

  :root {
    --bg-color: #020202;
    --accent-red: #ff3131;
    --accent-green: #00ff88;
    --accent-orange: #ff9d00;
    --accent-blue: #00d4ff;
    --text-main: #ffffff;
    --glass: rgba(255, 255, 255, 0.05);
    --glass-border: rgba(255, 255, 255, 0.15); /* Increased visibility */
    --current-aura: #00ff88;
    --panel-bg: rgba(12, 12, 12, 0.85); /* Darker, more readable background */
  }

  * { box-sizing: border-box; cursor: crosshair; user-select: none; }

  body {
    margin: 0; height: 100vh; width: 100vw; 
    background-color: var(--bg-color); color: var(--text-main);
    font-family: 'Space Grotesk', sans-serif; overflow: hidden; 
    background-image: radial-gradient(circle at 50% 50%, #111 0%, #000 100%);
    transition: filter 0.5s ease;
  }

  body.hard-focus { filter: grayscale(1) contrast(1.2); }
  body.hard-focus #bigDisplay { filter: grayscale(0); }

  /* --- HUD --- */
  #progressBar { 
    position: fixed; top: 0; left: 0; height: 4px; 
    background: var(--current-aura); z-index: 1000; 
    transition: width 0.3s linear, background 0.5s ease;
    box-shadow: 0 0 15px var(--current-aura);
  }

  /* URGENT BAR (Overlay) - Fixed overlapping */
  #topUrgent {
    position: absolute; top: 0; left: 0; width: calc(100% - 340px); 
    height: 0; opacity: 0; pointer-events: none;
    background: linear-gradient(180deg, rgba(255, 49, 49, 0.2) 0%, transparent 100%);
    transition: all 0.6s cubic-bezier(0.16, 1, 0.3, 1);
    display: flex; flex-direction: column; align-items: center; justify-content: flex-start;
    padding-top: 15px; z-index: 50; backdrop-filter: blur(4px);
  }
  #topUrgent.active { height: 140px; opacity: 1; pointer-events: auto; }

  .urgent-hms { font-family:'JetBrains Mono'; font-size: 3.5rem; font-weight: 700; color: var(--accent-red); letter-spacing: -2px; text-shadow: 0 0 30px var(--accent-red); line-height: 1; margin-bottom: 5px; }
  .urgent-label { font-size: 0.7rem; letter-spacing: 6px; color: #fff; opacity: 0.9; text-transform: uppercase; font-weight: 700;}

  /* --- LAYOUT GRID --- */
  .container { 
    display: grid; 
    grid-template-columns: 1fr 340px; /* Fixed Sidebar Width */
    height: 100vh; width: 100vw;
  }
  
  /* MAIN AREA */
  main { 
    position: relative;
    display: flex; flex-direction: column; 
    justify-content: space-between; 
    align-items: center;
    padding: 30px; 
    height: 100vh; overflow: hidden;
    transition: padding-top 0.6s ease;
  }
  /* Crucial Fix: Push content down when urgent bar is active */
  main.shifted { padding-top: 150px; }

  /* TICKER (Ghost Bar) */
  #leaderboardTicker { 
    background: rgba(0, 255, 136, 0.08); border: 1px solid var(--current-aura);
    padding: 10px 30px; border-radius: 40px; font-size: 0.75rem; 
    color: var(--current-aura); letter-spacing: 2px; text-transform: uppercase;
    text-align: center; width: fit-content; margin-bottom: 20px;
    box-shadow: 0 0 15px rgba(0,255,136,0.1);
    white-space: nowrap; z-index: 40;
  }

  /* TIMER CENTER */
  .timer-box {
    display: flex; flex-direction: column; 
    justify-content: center; align-items: center; 
    flex-grow: 1; width: 100%;
  }

  #bigDisplay { 
    font-size: clamp(5rem, 16vw, 13rem); 
    font-weight: 700; color: var(--current-aura);
    letter-spacing: -6px; transition: color 0.5s ease; 
    font-variant-numeric: tabular-nums;
    text-shadow: 0 0 80px rgba(0,255,136,0.15); line-height: 1;
    cursor: pointer; margin: 20px 0;
  }
  #bigDisplay:hover { opacity: 0.9; }

  .subject-tags { display: flex; gap: 15px; }
  .tag-btn { 
    background: transparent; border: 1px solid var(--glass-border); color: #888;
    padding: 12px 24px; font-size: 0.8rem; font-weight: 700; letter-spacing: 1px;
    border-radius: 6px; cursor: pointer; text-transform: uppercase; transition: 0.2s;
    font-family: 'Space Grotesk', sans-serif;
  }
  .tag-btn:hover { background: var(--glass); color: #fff; }
  .tag-btn.active.P { border-color: var(--accent-blue); color: var(--accent-blue); box-shadow: 0 0 15px rgba(0,212,255,0.1); background: rgba(0,212,255,0.05);}
  .tag-btn.active.C { border-color: var(--accent-red); color: var(--accent-red); box-shadow: 0 0 15px rgba(255,49,49,0.1); background: rgba(255,49,49,0.05);}
  .tag-btn.active.M { border-color: var(--accent-green); color: var(--accent-green); box-shadow: 0 0 15px rgba(0,255,136,0.1); background: rgba(0,255,136,0.05);}

  /* FOOTER CONTROLS */
  footer { 
    width: 100%; display: flex; flex-direction: column; gap: 20px; align-items: center;
    padding-bottom: 10px; z-index: 10;
  }
  
  .controls { 
    display: flex; gap: 12px; align-items: center; 
    background: var(--glass); padding: 12px; border-radius: 12px;
    border: 1px solid var(--glass-border); backdrop-filter: blur(10px);
  }
  
  input { 
    background: rgba(0,0,0,0.5); border: 1px solid var(--glass-border); 
    color: white; padding: 12px 0; width: 65px; font-family: 'Space Grotesk'; 
    font-weight: 700; font-size: 1.2rem; text-align: center; border-radius: 6px;
  }
  input:focus { outline: 1px solid var(--current-aura); border-color: var(--current-aura); }

  .play-btn { 
    background: var(--current-aura); color: black; border: none; 
    padding: 12px 40px; font-weight: 700; letter-spacing: 1px; border-radius: 6px;
    min-width: 130px; transition: transform 0.1s; cursor: pointer;
  }
  .play-btn:active { transform: scale(0.95); }

  .status-line { 
    display: flex; justify-content: space-between; width: 100%; 
    font-size: 0.75rem; letter-spacing: 2px; color: #bbb; /* Brighter Text */
    border-top: 1px solid var(--glass-border); padding-top: 20px;
    font-weight: 500;
  }
  .clickable-stat { cursor: pointer; transition: color 0.3s; }
  .clickable-stat:hover { color: var(--current-aura); text-shadow: 0 0 10px var(--current-aura); }

  /* --- SIDEBAR (FIXED VISIBILITY) --- */
  #sidebar { 
    background: var(--panel-bg); 
    backdrop-filter: blur(35px);
    border-left: 1px solid var(--glass-border); 
    display: flex; flex-direction: column; 
    padding: 35px 25px; gap: 25px; 
    overflow-y: auto; scrollbar-width: none; 
    height: 100vh;
  }
  
  .sidebar-header { 
    font-size: 0.7rem; font-weight: 700; color: #ddd; /* Brighter Header */
    letter-spacing: 3px; 
    text-transform: uppercase; border-bottom: 1px solid var(--glass-border); 
    padding-bottom: 8px; margin-top: 5px;
  }

  .fuel-container {
    background: linear-gradient(145deg, rgba(255,255,255,0.08) 0%, rgba(0,0,0,0.6) 100%);
    border: 1px solid var(--glass-border); border-left: 3px solid var(--current-aura);
    padding: 18px; border-radius: 6px; 
  }
  
  #motivationBox {
    font-family: 'JetBrains Mono', monospace; font-size: 0.8rem;
    color: #eee; line-height: 1.5; /* White text for readability */
  }

  .exam-card { 
    background: rgba(255,255,255,0.05); padding: 15px 18px; border-radius: 6px; 
    border: 1px solid var(--glass-border); margin-bottom: 8px;
    display: flex; justify-content: space-between; align-items: center;
  }
  .exam-card .days { font-size: 1.4rem; font-weight: 700; color: #fff; }
  .exam-card .label { font-size: 0.65rem; color: #ccc; text-transform: uppercase; font-weight: 600; }

  /* --- MODALS --- */
  .modal {
    position: fixed; inset: 0; background: rgba(0,0,0,0.92);
    display: none; align-items: center; justify-content: center; z-index: 2000;
    backdrop-filter: blur(8px);
  }
  .modal-box {
    background: #090909; border: 1px solid var(--glass-border);
    padding: 40px; width: 500px; border-radius: 12px;
    box-shadow: 0 0 60px rgba(0,0,0,0.8);
  }
  
  /* Leaderboard Styling */
  .rank-row {
    display: flex; justify-content: space-between; padding: 14px 0;
    border-bottom: 1px solid rgba(255,255,255,0.08); font-family: 'JetBrains Mono'; font-size: 0.95rem;
    color: #888;
  }
  .rank-row.me { color: var(--current-aura); text-shadow: 0 0 15px rgba(0,255,136,0.3); font-weight: 700; border-color: rgba(0,255,136,0.2); }
  .rank-row span:nth-child(1) { width: 70%; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;}
  .rank-row span:nth-child(2) { color: #fff; font-weight: 600;}

</style>
</head>
<body id="mainBody">

<div id="progressBar"></div>

<div id="levelModal" class="modal" onclick="closeModals()">
    <div class="modal-box" onclick="event.stopPropagation()">
        <div class="sidebar-header">Aspirant Rank Status</div>
        <h2 id="levelTitle" style="font-size: 3rem; margin: 15px 0; color: var(--accent-green); line-height:1;">NOVICE</h2>
        <p id="levelDesc" style="color: #ccc; margin-bottom: 25px; font-size: 0.9rem;"></p>
        <div style="background:#1a1a1a; height:6px; width:100%; margin-bottom:15px; border-radius:3px; overflow:hidden;">
            <div id="levelBar" style="background:var(--accent-green); height:100%; width:0%; transition:1s;"></div>
        </div>
        <div id="levelStats" style="font-weight:700; font-size: 0.8rem; color:#888;"></div>
    </div>
</div>

<div id="leaderboardModal" class="modal" onclick="closeModals()">
    <div class="modal-box" onclick="event.stopPropagation()">
        <div class="sidebar-header" style="display:flex; justify-content:space-between; align-items:center;">
            <span>Global Live Standing</span>
            <span style="color:var(--accent-red); font-size:0.6rem; animation: blink 1s infinite;">‚óè LIVE</span>
        </div>
        <div id="ghostList" style="margin-top: 20px; max-height: 450px; overflow-y: auto; scrollbar-width: none;"></div>
        <div style="margin-top: 25px; font-size: 0.7rem; color: #444; text-align: center;">*Syncing with active nodes...</div>
    </div>
</div>

<style> @keyframes blink { 50% { opacity: 0.4; } } </style>

<div id="topUrgent">
    <div class="urgent-hms" id="urgentHMS">00:00:00</div>
    <div class="urgent-label" id="urgentExamName">PROTOCOL: ACTIVE</div>
</div>

<div class="container">
  <main id="mainFrame">
    <div id="leaderboardTicker">SAT-LINK: SECURED</div>

    <div class="timer-box">
      <div class="subject-tags">
        <button class="tag-btn P" id="btn-P" onclick="setSubject('P')">Physics</button>
        <button class="tag-btn C" id="btn-C" onclick="setSubject('C')">Chemistry</button>
        <button class="tag-btn M active" id="btn-M" onclick="setSubject('M')">Maths</button>
      </div>
      <div id="bigDisplay" onclick="swapDisplays()">00:00:00</div>
    </div>

    <footer>
      <div class="controls">
          <input type="number" id="hh" placeholder="HH">
          <span style="opacity:0.3; color:white;">:</span>
          <input type="number" id="mm" placeholder="MM">
          <button id="playPauseBtn" class="play-btn" onclick="toggleTimer()">START</button>
          <button class="tag-btn" onclick="resetTimer()" style="padding: 12px;">Reset</button>
          <button id="hardBtn" class="tag-btn" onclick="toggleHardFocus()" style="padding: 12px;">Hard Focus</button>
      </div>
      <div class="status-line">
        <div class="clickable-stat" onclick="openLevelModal()">RANK: <span id="rankBadge">NOVICE</span></div>
        <div id="focusScore">FOCUS: 100/100</div>
        <div id="dailyTotal">LOG: 0h 0m</div>
        <div id="smallDisplay" onclick="swapDisplays()" style="cursor:pointer; opacity: 0.7;">00:00:00</div>
        <div class="clickable-stat" onclick="openLeaderboard()">OJAS KADAM</div>
      </div>
    </footer>
  </main>

  <aside id="sidebar">
    <div class="sidebar-header">Deployment Timelines</div>
    <div id="jeeTracker"></div>
    
    <div class="sidebar-header">Mental Fuel</div>
    <div class="fuel-container">
        <div id="motivationBox">"Initializing neurotransmitter optimization..."</div>
    </div>

    <div class="sidebar-header">System Log</div>
    <div id="sessionHistory" style="font-family:'JetBrains Mono'; font-size:0.7rem; color:#aaa; display: flex; flex-direction: column; gap: 8px;">
        No session data recorded for today.
    </div>
  </aside>
</div>

<script>
/**
 * TITAN OMEGA CORE LOGIC v2.2 (Fixed NaN, Ranking & Visibility)
 */

const State = {
    totalSeconds: 0,
    initialSeconds: 0,
    running: false,
    isSwapped: false,
    isHardFocus: false,
    lastTimestamp: performance.now(),
    currentSubject: 'M',
    pauseCount: 0,
    dailyData: JSON.parse(localStorage.getItem('studyLog_v2')) || {},
    today: new Date().toISOString().split('T')[0],
    sessionActive: false,
    urgentTarget: null
};

// 1. DATA SANITIZATION (Fixes the NaN Error)
if (!State.dailyData[State.today]) {
    State.dailyData[State.today] = { P: 0, C: 0, M: 0, pauses: 0, sessions: [] };
} else {
    // Force numbers if they are missing or undefined
    const d = State.dailyData[State.today];
    if (typeof d.P !== 'number') d.P = 0;
    if (typeof d.C !== 'number') d.C = 0;
    if (typeof d.M !== 'number') d.M = 0;
    if (!Array.isArray(d.sessions)) d.sessions = [];
}

// 2. SIMULATED COMPETITORS (Generates "Fake" Leaderboard Data)
const Competitors = [];
function initCompetitors() {
    const names = ["AIR_1_Candidate", "Kota_Reaper", "Irodov_Slayer", "System_X", "Aspirant_007", "Physics_God", "Mains_Killer", "Silent_Topper", "Dorm_Room_Guy", "Library_Ghost", "Cengage_Boy", "Allen_Survivor"];
    
    for(let i=0; i<12; i++) {
        // Create realistic base hours based on time of day
        let currentHour = new Date().getHours();
        let baseHours = (currentHour > 6) ? (currentHour - 6) * (0.5 + Math.random()*0.5) : 0;
        baseHours += (Math.random() * 2);

        Competitors.push({
            name: names[i],
            speed: 0.9 + (Math.random() * 0.3), // Study speed multiplier
            hours: baseHours
        });
    }
}
initCompetitors();

const Config = {
    examDates: {
        "JEE Mains Jan": new Date("2026-01-24T14:00:00"),
        "HSC Boards": new Date("2026-02-11T09:00:00"),
        "JEE Mains April": new Date("2026-04-01T09:00:00"),
        "MHT-CET 2026": new Date("2026-04-15T09:00:00"),
        "JEE Advanced": new Date("2026-06-07T09:00:00")
    },
    quotes: [
        "IIT Bombay isn't built in a day, but it's lost in a second of laziness.",
        "Your competition is studying right now. Are you?",
        "JEE Advanced is a test of character, not just caliber.",
        "Every MCQ you skip is someone else's rank improving.",
        "Consistency is the difference between a dreamer and a topper.",
        "Calculus doesn't care about your feelings.",
        "Discipline shows up even when motivation ghosts you.",
        "Pressure is proof you‚Äôre in the game.",
        "Discipline shows up even when motivation ghosts you.", "No one remembers comfort, everyone remembers results.", "Today‚Äôs effort is tomorrow‚Äôs confidence.", "You don‚Äôt need a perfect day, just an honest one.", "Boring work builds extraordinary outcomes.", "Consistency is talent that doesn‚Äôt quit.", "Every focused hour compounds silently.", "You‚Äôre not behind, you‚Äôre building.", "Excuses feel good now, ranks feel good later.", "The grind you avoid today comes back tomorrow.", "Confidence is earned, not imagined.", "Do the work even when it feels pointless.", "Hard days are part of the syllabus.", "You‚Äôre training your mind, not just learning facts.", "The rank doesn‚Äôt care how you felt.", "Discipline is remembering what you want.", "You don‚Äôt rise to motivation, you fall to habits.", "The quiet sessions matter most.", "Pressure is proof you‚Äôre in the game.", "Small wins stack into big results.", "No one sees this effort, and that‚Äôs fine.", "Comfort delays progress.", "Focus is a competitive advantage.", "You don‚Äôt need more time, you need fewer excuses.", "The work you skip becomes your weakness.", "This phase decides the next decade.", "You‚Äôre allowed to be tired, not to quit.", "Serious goals demand serious days.", "Your future self is watching.", "Effort beats luck every single time.", "The grind is temporary, regret lasts longer.", "You‚Äôre building proof, not hope.", "Stay boring, stay consistent.", "Talent fades, discipline stays.", "Every session counts.", "This is where separation happens.", "Hard work makes pressure manageable.", "Results respect preparation.", "Do it right, even when it‚Äôs slow.", "You don‚Äôt need validation, you need progress.", "One more focused hour changes things.", "The work is the shortcut.", "Discipline creates freedom.", "Your ceiling rises with effort.", "Don‚Äôt negotiate with weakness.", "Momentum starts with action.", "Show up before confidence arrives.", "Today‚Äôs pain buys tomorrow‚Äôs calm.", "You‚Äôre closer than you think.", "No effort is wasted.", "Build stamina, not excuses.", "The process rewards loyalty.", "You‚Äôre earning resilience.", "This is training for life, not just an exam.", "Serious days create serious results.", "Stay present, stay disciplined.", "You don‚Äôt need intensity forever, just consistency.", "Growth hides in repetition.", "Trust the grind.", "Do it tired.", "Progress loves patience.", "Every honest session matters.", "You‚Äôre becoming harder to beat.", "Stay focused, stay dangerous.", "This work compounds quietly.", "Discipline never embarrasses you.", "Your habits are your rank.", "No shortcuts, just standards.", "Effort is always respected.", "Keep going.", "Stay locked in.", "Finish strong.", "Again tomorrow."
    ],
    ghosts: [
        "AIR_1 is currently solving Irodov.",
        "Someone in Kota just hit 14 hours.",
        "User_772 upgraded to 'Titan' rank.",
        "Server load high: Late night grinders active.",
        "Physics cycle completed by 4,202 users.",
        "User_99 just locked in for 8 hours straight, no music, no distractions.", "Someone in Kota just walked out of a full mock and went straight to analysis.", "A silent grinder in Chennai finished revising electrochem before sunrise.", "User_A17 fixed their sleep schedule and started studying at 5 a.m.", "Someone you‚Äôll never meet just solved 50 calculus questions today.", "A dropper in Jaipur just crossed 200 consecutive study days.", "User_42 chose PYQs over reels tonight.", "Someone in a hostel just memorized all qualitative inorganic trends.", "A ranker-in-the-making just said no to a party.", "User_X just finished a 3-hour physics test without checking the clock.", "Someone in Kota redid the same mock to fix silly mistakes.", "User_88 finally stopped overthinking and started solving.", "A quiet competitor just completed NCERT line by line.", "Someone out there studied while everyone else slept.", "User_Z stayed back after coaching to clear doubts.", "A focused mind somewhere just mastered circles today.", "Someone just turned their phone off for the next 6 hours.", "User_19 just broke their personal best in accuracy.", "A serious aspirant just finished revision instead of starting something new.", "Someone you don‚Äôt see on Instagram is getting better every day.", "User_61 just solved that question you skipped.", "A Kota student just analyzed mistakes instead of blaming the paper.", "Someone just chose discipline over motivation.", "User_P kept going even after a bad mock.", "A competitor just improved speed by 10 percent today.", "Someone just realized consistency beats talent.", "User_73 is on their 4th study session today.", "A silent worker just finished coordination compounds.", "Someone just studied even when they didn‚Äôt feel like it.", "User_K fixed weak chapters instead of strong ones.", "A focused student somewhere just rewrote formulas.", "Someone just stopped waiting for the perfect mood.", "User_11 studied through mental fatigue.", "A grinder just finished p-block revision.", "Someone just did error analysis properly.", "User_90 chose long-term rank over short-term comfort.", "A determined aspirant just solved advanced-level problems.", "Someone just showed up, again.", "User_M completed a full-length test under time pressure.", "A serious student just accepted their mistakes.", "Someone just studied while it was boring.", "User_5 stayed disciplined after dinner.", "A competitor just strengthened their weakest subject.", "Someone just trusted the process.", "User_27 did focused revision, not random reading.", "A Kota aspirant just said no excuses today.", "Someone just built stamina by studying tired.", "User_Q stayed consistent on a bad day.", "A future ranker just chose effort over ego.", "Someone just got a little better than yesterday.", "User_81 didn‚Äôt quit midway.", "A disciplined mind just kept going.", "Someone just outworked their doubts.", "User_R stayed silent and studied.", "A competitor just turned pressure into progress.", "Someone just did the hard thing first.", "User_66 stayed locked in till the timer ended.", "A focused student just refused to drift.", "Someone just earned confidence through work.", "User_38 kept promises to themselves.", "A serious aspirant just finished revision on time.", "Someone just chose growth.", "User_N pushed through resistance.", "A silent winner just kept grinding.", "Someone just proved discipline beats mood.", "User_14 stayed honest with prep.", "A competitor just invested another hour.", "Someone just chose the long road.", "User_52 fixed concepts instead of shortcuts.", "A focused mind just stayed present.", "Someone just kept moving forward.", "User_100 didn‚Äôt stop when it got hard."
    ]
};

// --- ENGINE (Runs ~60fps) ---
function engine(timestamp) {
    const delta = (timestamp - State.lastTimestamp) / 1000;
    State.lastTimestamp = timestamp;

    if (State.running && State.totalSeconds > 0) {
        State.totalSeconds -= delta;
        State.dailyData[State.today][State.currentSubject] += delta;
        
        if (State.totalSeconds <= 0) {
            handleTimerComplete();
        }
    }
    
    // Increment Competitor Time (Simulation)
    const hour = new Date().getHours();
    if (hour >= 5 && hour <= 23) {
        Competitors.forEach(c => {
            if(Math.random() > 0.05) c.hours += (delta / 3600) * c.speed; 
        });
    }

    // LIVE URGENT TIMER UPDATE (Every frame logic)
    if(State.urgentTarget) {
        const diff = State.urgentTarget - new Date();
        if(diff > 0) {
            document.getElementById('urgentHMS').textContent = formatHMS(Math.floor(diff/1000), true);
        }
    }

    updateUI();
    requestAnimationFrame(engine);
}

function handleTimerComplete() {
    State.running = false;
    State.sessionActive = false;
    document.getElementById('playPauseBtn').textContent = "START";
    new Audio('https://actions.google.com/sounds/v1/alarms/beep_short.ogg').play();
    saveData();
    State.totalSeconds = 0;
}

function updateUI() {
    const timerStr = formatHMS(Math.max(0, State.totalSeconds));
    const clockStr = new Date().toLocaleTimeString('en-IN', { hour12: false });
    
    document.getElementById(State.isSwapped ? "smallDisplay" : "bigDisplay").textContent = timerStr;
    document.getElementById(State.isSwapped ? "bigDisplay" : "smallDisplay").textContent = clockStr;

    // Progress Bar
    if(State.initialSeconds > 0) {
        const perc = ((State.initialSeconds - State.totalSeconds) / State.initialSeconds) * 100;
        const bar = document.getElementById("progressBar");
        bar.style.width = Math.min(100, perc) + "%";
        
        const colors = perc < 60 ? 'var(--accent-green)' : (perc < 90 ? 'var(--accent-orange)' : 'var(--accent-red)');
        bar.style.background = colors;
        bar.style.boxShadow = `0 0 20px ${colors}`;
    }

    // Stats - SAFE CALCULATION (Prevents NaN)
    const d = State.dailyData[State.today];
    const totalS = (d.P || 0) + (d.C || 0) + (d.M || 0);
    const focus = totalS === 0 ? 100 : Math.max(0, Math.floor(100 - (State.pauseCount * 4) + (totalS / 10000)));
    
    document.getElementById('focusScore').textContent = `FOCUS: ${focus}/100`;
    document.getElementById('dailyTotal').textContent = `LOG: ${Math.floor(totalS/3600)}h ${Math.floor((totalS%3600)/60)}m`;
}

function updateTracker() {
    const now = new Date();
    let urgent = null;
    let trackerHtml = "";
    
    // Sort exams by date
    const sortedExams = Object.entries(Config.examDates).sort((a,b) => a[1] - b[1]);

    for (const [name, date] of sortedExams) {
        const diff = date - now;
        const days = Math.ceil(diff / 86400000);
        
        if (days > 0) {
            // Check for Urgent Banner (First exam within 7 days)
            if (!urgent && days < 8) urgent = { name, date };
        
            const color = days < 7 ? "var(--accent-red)" : (days < 30 ? "var(--accent-orange)" : "var(--accent-green)");
            trackerHtml += `
                <div class="exam-card" style="border-left: 2px solid ${color}">
                    <span class="days" style="color:${color}">${days}d</span>
                    <span class="label">${name}</span>
                </div>
            `;
        }
    }
    document.getElementById("jeeTracker").innerHTML = trackerHtml;

    // Handle Top Urgent Banner Visuals
    const banner = document.getElementById('topUrgent');
    const main = document.getElementById('mainFrame');
    
    if (urgent) {
        State.urgentTarget = urgent.date; // Set for Engine Loop
        banner.classList.add('active');
        main.classList.add('shifted'); // Push content down
        document.getElementById('urgentExamName').textContent = urgent.name.toUpperCase() + " DEADLINE";
    } else {
        State.urgentTarget = null;
        banner.classList.remove('active');
        main.classList.remove('shifted');
    }
}

// --- CORE ACTIONS ---
function toggleTimer() {
    const btn = document.getElementById("playPauseBtn");
    if (!State.running) {
        // If 0, load from inputs
        if (State.totalSeconds <= 0) {
            const h = parseInt(document.getElementById("hh").value) || 0;
            const m = parseInt(document.getElementById("mm").value) || 0;
            State.totalSeconds = (h * 3600) + (m * 60);
            State.initialSeconds = State.totalSeconds;
            
            if (State.totalSeconds > 0) {
                State.dailyData[State.today].sessions.push({ sub: State.currentSubject, time: new Date().toLocaleTimeString('en-US', {hour: '2-digit', minute:'2-digit'}) });
                renderSessionLog();
            }
        }
        
        if (State.totalSeconds > 0) {
            State.running = true;
            btn.textContent = "PAUSE";
            btn.style.background = "#fff"; 
        }
    } else {
        // Pausing
        State.running = false;
        State.pauseCount++;
        btn.textContent = "RESUME";
        btn.style.background = "var(--current-aura)";
    }
    saveData();
}

function resetTimer() {
    State.running = false;
    State.totalSeconds = 0;
    State.initialSeconds = 0;
    document.getElementById("playPauseBtn").textContent = "START";
    document.getElementById("playPauseBtn").style.background = "var(--current-aura)";
    document.getElementById("progressBar").style.width = "0%";
    document.getElementById("hh").value = "";
    document.getElementById("mm").value = "";
}

function setSubject(sub) {
    State.currentSubject = sub;
    document.querySelectorAll('.tag-btn').forEach(b => b.classList.remove('active'));
    document.getElementById('btn-' + sub).classList.add('active');
    
    const auraMap = { 'P': '#00d4ff', 'C': '#ff3131', 'M': '#00ff88' };
    document.documentElement.style.setProperty('--current-aura', auraMap[sub]);
    
    if(!State.running) document.getElementById("playPauseBtn").style.background = auraMap[sub];
}

function toggleHardFocus() {
    State.isHardFocus = !State.isHardFocus;
    document.body.classList.toggle('hard-focus', State.isHardFocus);
    document.getElementById('hardBtn').textContent = State.isHardFocus ? "LOCKED" : "Hard Focus";
    document.getElementById('hardBtn').style.borderColor = State.isHardFocus ? "var(--current-aura)" : "var(--glass-border)";
}

// --- MODAL & LOGIC (Fixed Calculations) ---
function openLevelModal() {
    // 1. Calculate safe total hours
    let totalSeconds = 0;
    Object.values(State.dailyData).forEach(day => {
        totalSeconds += (day.P || 0) + (day.C || 0) + (day.M || 0);
    });
    
    const totalH = totalSeconds / 3600;
    
    const thresholds = [0, 10, 50, 150, 400, 1000];
    let idx = 0;
    while(idx < thresholds.length - 1 && totalH >= thresholds[idx+1]) idx++;
    
    const titles = ["Novice", "Aspirant", "Grinder", "Titan", "Omega", "Immortal"];
    
    // Prevent index out of bounds
    idx = Math.min(idx, titles.length - 1);
    
    const currentT = thresholds[idx];
    const nextT = thresholds[idx+1] || (currentT * 2);
    let progress = 0;
    
    if (nextT > currentT) {
        progress = Math.min(100, ((totalH - currentT) / (nextT - currentT)) * 100);
    }
    
    document.getElementById('levelTitle').textContent = titles[idx].toUpperCase();
    document.getElementById('rankBadge').textContent = titles[idx].toUpperCase();
    document.getElementById('levelDesc').textContent = `Protocol check for OJAS KADAM. Cumulative depth: ${totalH.toFixed(2)} hours.`;
    document.getElementById('levelBar').style.width = progress + "%";
    document.getElementById('levelStats').textContent = `${(nextT - totalH).toFixed(1)}H TO NEXT RANK`;
    document.getElementById('levelModal').style.display = 'flex';
}

function openLeaderboard() {
    const d = State.dailyData[State.today];
    const mySeconds = (d.P || 0) + (d.C || 0) + (d.M || 0);
    const myHours = mySeconds / 3600;
    
    // Mix user into competitors
    const liveRanking = [...Competitors, { name: "OJAS KADAM", hours: myHours, isMe: true }];
    
    // Sort descending
    liveRanking.sort((a,b) => b.hours - a.hours);

    let html = "";
    liveRanking.forEach((u, i) => {
        const isMe = u.isMe ? 'me' : '';
        const rank = i + 1;
        const icon = rank === 1 ? 'üëë' : (rank <= 3 ? '‚ö°' : '#');
        
        html += `
            <div class="rank-row ${isMe}">
                <span>${icon}${rank} ${u.name}</span>
                <span>${u.hours.toFixed(2)}h</span>
            </div>
        `;
    });
    
    document.getElementById('ghostList').innerHTML = html;
    document.getElementById('leaderboardModal').style.display = 'flex';
}

function renderSessionLog() {
    const sessions = State.dailyData[State.today].sessions || [];
    const container = document.getElementById('sessionHistory');
    
    if (sessions.length === 0) {
        container.innerHTML = "No session data recorded for today.";
        return;
    }
    
    container.innerHTML = sessions.slice().reverse().map(s => 
        `<div style="border-bottom:1px solid #222; padding:8px 0;">
            <span style="color:var(--current-aura); font-weight:700;">[${s.time}]</span> 
            ${s.sub === 'P' ? 'PHYSICS' : (s.sub === 'C' ? 'CHEM' : 'MATHS')} INIT
         </div>`
    ).join('');
}

// --- UTILS ---
function formatHMS(s, full = false) {
    const h = Math.floor(s/3600), m = Math.floor((s%3600)/60), sec = Math.floor(s%60);
    if(full) return `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}:${String(sec).padStart(2,'0')}`;
    return `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}:${String(sec).padStart(2,'0')}`;
}
function swapDisplays() { State.isSwapped = !State.isSwapped; }
function closeModals() { document.querySelectorAll('.modal').forEach(m => m.style.display = 'none'); }
function saveData() { localStorage.setItem('studyLog_v2', JSON.stringify(State.dailyData)); }

// Keyboard Shortcuts
document.addEventListener('keydown', (e) => {
    if (e.target.tagName === 'INPUT') return;

    const k = e.key.toLowerCase();

    // TIMER
    if (k === ' ' || e.code === 'Space') {
        e.preventDefault();
        toggleTimer();
    }

    // RESTART
    if (k === 'r') resetTimer();

    // HARD FOCUS
    if (k === 'h') toggleHardFocus();

    // FULLSCREEN
    if (k === 'f') toggleFullscreen();

    // SUBJECT SWITCH
    if (k === 'm' || k === '3') setSubject('M'); // Maths
    if (k === 'p' || k === '1') setSubject('P'); // Physics
    if (k === 'c' || k === '2') setSubject('C'); // Chemistry
});


// Update ticker text occasionally
setInterval(() => {
    document.getElementById('leaderboardTicker').textContent = Config.ghosts[Math.floor(Math.random() * Config.ghosts.length)];
    document.getElementById('motivationBox').textContent = `"${Config.quotes[Math.floor(Math.random() * Config.quotes.length)]}"`;
    updateTracker(); // Check for urgent banner updates
    saveData();
}, 20000);

// Init
updateTracker();
renderSessionLog();
openLevelModal(); // Calculate initial rank
closeModals(); // Hide modal after calc
setSubject('M'); // Default
requestAnimationFrame(engine);

function toggleFullscreen() {
    if (!document.fullscreenElement) {
        document.documentElement.requestFullscreen().catch(err => {});
    } else {
        document.exitFullscreen();
    }
}


</script>
</body>
</html>
